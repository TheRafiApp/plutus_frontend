{"version":3,"sources":["view/properties/PropertyUnitsView.js"],"names":["define","app","LeasesCollection","PropertiesCollection","UnitsCollection","PropertyUnitsTemplate","Backbone","View","extend","className","events","change select.properties","change select.units","template","_","verifyCollection","collection","length","renderError","collectionName","this","context","initialize","options","self","properties","fetch","then","selected_property","first","get","units","parentModelId","render","filterProperties","activeOnly","filterUnits","$el","html","selected_unit","toJSON","find","chosen","width","delegateEvents","trigger","filtered","filter","property","unit","check","leases","hasActiveLeases","each","lease","active","propertyChange","value","val","reset","success","unitChange"],"mappings":"AAIAA,QACE,MACA,qCACA,6CACA,wCACA,iDAEF,SACEC,EACAC,EACAC,EACAC,EACAC,GAGA,MAAOC,UAASC,KAAKC,QAEnBC,UAAW,iBAEXC,QACEC,2BAA4B,iBAC5BC,sBAAuB,cAGzBC,SAAUC,EAAED,SAASR,GAErBU,iBAAkB,SAASC,GACzB,QAAIA,EAAWC,OAAS,IAI1BC,YAAa,SAASC,GACpBC,KAAKC,QAAQH,YACX,oCACAC,EACA,wFAIJG,WAAY,SAASC,GACfA,GAAST,EAAEN,OAAOY,KAAMG,EAC5B,IAAIC,GAAOJ,IAEXA,MAAKK,WAAa,GAAItB,GACtBiB,KAAKK,WAAWC,QAAQC,KAAK,WAC3B,MAAKH,GAAKT,iBAAiBS,EAAKC,aAEhCD,EAAKI,kBAAoBJ,EAAKI,mBAAqBJ,EAAKC,WAAWI,QAAQC,IAAI,OAC/EN,EAAKO,MAAQ,GAAI3B,GAAgB,MAC/B4B,cAAeR,EAAKI,wBAEtBJ,GAAKO,MAAML,QAAQC,KAAK,WACtB,MAAKH,GAAKT,iBAAiBS,EAAKO,WAEhCP,GAAKS,SAF0CT,EAAKN,YAAY,YAPdM,EAAKN,YAAY,iBAczEe,OAAQ,WAuBN,MAnBAb,MAAKK,WAAaL,KAAKc,mBAInBd,KAAKe,aAAYf,KAAKW,MAAQX,KAAKgB,eAEvChB,KAAKiB,IAAIC,KAAKlB,KAAKP,UACjBe,kBAAmBR,KAAKQ,kBACxBW,cAAenB,KAAKmB,cACpBd,WAAYL,KAAKK,WAAWe,SAC5BT,MAAOX,KAAKW,MAAMS,YAGpBpB,KAAKiB,IAAII,KAAK,WAAWC,QAASC,MAAO,SAEzCvB,KAAKwB,iBAELxB,KAAKC,QAAQwB,QAAQ,kBAEdzB,MAGTc,iBAAkB,WAChB,GAAIY,GAAW1B,KAAKK,WAAWsB,OAAO,SAASC,GAC7C,GAAIjB,GAAQiB,EAASlB,IAAI,QACzB,OAAOC,IAA0B,IAAjBA,EAAMd,QAExB,OAAO,IAAId,GAAqB2C,IAGlCV,YAAa,WACX,GAAIU,GAAW1B,KAAKW,MAAMgB,OAAO,SAASE,GACxC,GAAIC,IAAQ,EACRC,EAASF,EAAKnB,IAAI,SAEA,KAAlBqB,EAAOlC,SAAciC,GAAQ,EAEjC,IAAIE,IAAkB,CAUtB,OARAD,GAAS,GAAIjD,GAAiBiD,GAE9BA,EAAOE,KAAK,SAASC,GACfA,EAAMC,SAAQH,GAAkB,KAGjCA,IAAiBF,GAAQ,GAEvBA,GAET,OAAO,IAAI9C,GAAgB0C,IAG7BU,eAAgB,WACd,GAAIhC,GAAOJ,KACPqC,EAAQrC,KAAKiB,IAAII,KAAK,qBAAqBiB,KAE/CtC,MAAKQ,kBAAoB6B,EACzBrC,KAAKW,MAAM4B,QACXvC,KAAKW,MAAQ,GAAI3B,GAAgB,MAC/B4B,cAAeyB,IAGjBrC,KAAKW,MAAML,QAAQkC,QAAQ,WACzBpC,EAAKS,YAKT4B,WAAY,WACVzC,KAAKC,QAAQwB,QAAQ","file":"PropertyUnitsView.js","sourcesContent":["/**\n * /properties/PropertyUnitsView.js\n */\n\ndefine([\n  'app',\n  'collection/leases/LeasesCollection',\n  'collection/properties/PropertiesCollection',\n  'collection/properties/UnitsCollection',\n  'text!templates/properties/property_units.html'\n],\nfunction(\n  app, \n  LeasesCollection,\n  PropertiesCollection, \n  UnitsCollection, \n  PropertyUnitsTemplate\n) {\n\n  return Backbone.View.extend({\n\n    className: 'property-units',\n\n    events: {\n      'change select.properties': 'propertyChange',\n      'change select.units': 'unitChange'\n    },\n\n    template: _.template(PropertyUnitsTemplate),\n\n    verifyCollection: function(collection) {\n      if (collection.length < 1) return false;\n      else return true;\n    },\n\n    renderError: function(collectionName) { \n      this.context.renderError(\n        'It looks like you don\\'t have any ' + \n        collectionName + \n        ', you need to have a property, unit, and active lease before you can create a bill.'\n      );\n    },\n\n    initialize: function(options) {\n      if (options) _.extend(this, options);\n      var self = this;\n\n      this.properties = new PropertiesCollection();\n      this.properties.fetch().then(function() {\n        if (!self.verifyCollection(self.properties)) return self.renderError('properties');\n\n        self.selected_property = self.selected_property || self.properties.first().get('_id');\n        self.units = new UnitsCollection(null, {\n          parentModelId: self.selected_property\n        });\n        self.units.fetch().then(function() {\n          if (!self.verifyCollection(self.units)) return self.renderError('units');\n\n          self.render();\n        });\n      });\n    },\n\n    render: function() {\n\n      // only show properties that have units\n      \n      this.properties = this.filterProperties();\n\n      // if specified, only show units that have active leases\n      \n      if (this.activeOnly) this.units = this.filterUnits();\n\n      this.$el.html(this.template({\n        selected_property: this.selected_property,\n        selected_unit: this.selected_unit,\n        properties: this.properties.toJSON(),\n        units: this.units.toJSON()\n      }));\n\n      this.$el.find('.chosen').chosen({ width: '100%' });\n\n      this.delegateEvents();\n\n      this.context.trigger('addressChanged');\n\n      return this;\n    },\n\n    filterProperties: function() {\n      var filtered = this.properties.filter(function(property) {\n        var units = property.get('units');\n        return units && units.length !== 0;\n      });\n      return new PropertiesCollection(filtered);\n    },\n\n    filterUnits: function() {\n      var filtered = this.units.filter(function(unit) {\n        var check = true;\n        var leases = unit.get('leases');\n\n        if (leases.length === 0) check = false;\n\n        var hasActiveLeases = false;\n\n        leases = new LeasesCollection(leases);\n\n        leases.each(function(lease) {\n          if (lease.active) hasActiveLeases = true;\n        });\n\n        if (!hasActiveLeases) check = false;\n\n        return check;\n      });\n      return new UnitsCollection(filtered);\n    },\n\n    propertyChange: function() {\n      var self = this;\n      var value = this.$el.find('select.properties').val();\n\n      this.selected_property = value;\n      this.units.reset();\n      this.units = new UnitsCollection(null, {\n        parentModelId: value\n      });\n\n      this.units.fetch().success(function() {\n        self.render();\n      });\n      \n    },\n\n    unitChange: function() {\n      this.context.trigger('addressChanged');\n    }\n   \n  });\n});"]}