define(["app","model/properties/PropertyModel","model/properties/UnitModel","model/leases/LeaseModel","model/users/TenantModel","text!templates/account/account-data.html","text!templates/repeaters/import-summary.html","jszip","xlsx"],function(e,t,a,s,r,n,i,o){return Backbone.View.extend({className:"account account-data",events:{"click .action-cancel":"resetView","click .action-save":"promptSave","change #file-input":"filesChosen",drop:"filesDropped",dragover:"dragOver",dragleave:"dragOff"},supported:["xls","xlsx","xlsm","xlsb","xml","ods"],propertyFields:["Address","Name"],unitFields:["Number","Beds","Baths","Sq Ft","Start Date","End Date"],tenantFields:["First Name","Last Name","Email","Phone"],template:_.template(n),template_summary:_.template(i),initialize:function(){window.JSZip=o,this.render()},render:function(){return this.on("confirmSave",this.submitData,this),this.queue={property:[],unit:[],lease:[],tenant:[]},this.$el.html(this.template()),this.delegateEvents(),this},filesChosen:function(e){var t="",a=this.$el.find("#file-input"),s=this.$el.find(".action-choose");e||(e={target:{value:"",files:[]}});var r=e.target.files,n="CHOOOSE FILE";t=r&&r.length>1?(a.attr("data-multiple-caption")||"").replace("{count}",r.length):e.target.value.split("\\").pop(),t?s.children("span").text(t):s.children("span").text(n),r.length>0&&this.processFiles(r)},dragOver:function(e){e.preventDefault(),this.$el.find(".file-drop").addClass("hover")},dragOff:function(){this.$el.find(".file-drop").removeClass("hover")},filesDropped:function(e){e.preventDefault(),e.stopPropagation();var t=e.originalEvent.dataTransfer.files;this.$el.find(".file-drop").removeClass("hover").addClass("loading"),this.processFiles(t)},processFiles:function(t){this.errors=!1,this.$el.find(".messages").text("");var a,s=this,r=[],n=[];return _.each(t,function(t){var i=new FileReader,o=t.name,l=$.Deferred(),d=o.indexOf(".")>-1?o.split(".").slice(-1)+"":"unknown";return s.supported.indexOf(d)<0?("unknown"!==d&&(d="."+d),e.alerts.error("Filetype "+(t.type||d)+" not suported"),s.$el.find(".file-drop").removeClass("loading"),a=!0,l.reject()):(i.onload=function(e){var t=e.target.result,a=XLSX.read(t,{type:"binary"});return a.SheetNames.forEach(function(e){var t=a.Sheets[e],r=XLSX.utils.sheet_to_json(t),i=s.processData(r,t);n.push(i)}),l.resolve()},i.readAsBinaryString(t),void r.push(l))}),!a&&void $.when.apply($,r).then(function(){s.validateAll(n)})},invalidate:function(e){var t=new Error,a=e;throw this.displayErrorMessage(a),t.message=a,t},processData:function(t,a){var s=this,r={};t=t.slice(1);var n=0,i=0,o=0,l=[];if(t.forEach(function(t,d){var u=s.getModelType(t);switch(u||e.alerts.warn("Your data is not formatted correctly"),u){case"property":r.length>0&&(n=0),n=0,i=0,o=0;var c={};for(var p in t){switch(p){case"Address":var f=t[p],h=f.split(",");h=h.map(function(e){return $.trim(e)});try{c.address=h[0],c.city=h[1],c.state=h[2].split(" ")[0],c.zip=h[2].split(" ")[1],c.country=h[3]||"USA"}catch(e){s.invalidate("Invalid address: "+f)}break;case"Name":c.name=t[p];break;default:var m={},v=p+"",g=s.getLocation(p,a);m[g]=v,l.push(m)}r=c}break;case"unit_lease":0===n?(n++,r.units=[]):(n=1,i++),o=0;var y={leases:[{}]};for(p in t)switch(p){case"Number":y.number=t[p];break;case"Beds":y.beds=t[p];break;case"Baths":y.baths=t[p];break;case"Sq Ft":y.sq_ft=t[p];break;case"Rent":y.rent=e.utils.parseMoney(t[p]),y.leases[0].rent=e.utils.parseMoney(t[p]);break;case"Start Date":y.leases[0].start_date=t[p];break;case"End Date":y.leases[0].end_date=t[p];break;case"First Month":y.leases[0].first_month="-"+e.utils.parseMoney(t[p]);break;case"Last Month":y.leases[0].last_month="-"+e.utils.parseMoney(t[p]);break;case"Security":y.leases[0].security=e.utils.parseMoney(t[p]);break;default:var m={},v=p+"",g=s.getLocation(p,a);m[g]=v,l.push(m)}r.units.push(y);break;case"tenant":1==n&&(n++,r.units[i].leases[0].tenants=[]);var b={};for(p in t)switch(p){case"First Name":b.first_name=t[p];break;case"Last Name":b.last_name=t[p];break;case"Phone":b.phone=e.utils.validateContact(t[p],!0).phone;break;case"Email":b.email=t[p];break;default:var m={},v=p+"",g=s.getLocation(p,a);m[g]=v,l.push(m)}r.units[i].leases[0].tenants.push(b);break;default:console.warn(t,d),console.warn("a row of bad data was found")}}),l.length>0){console.warn(l);var d=this.parseKeyErrors(l);return this.displayKeyErrors(d),!1}return console.log(r),r.units&&r.units.forEach(function(e,t){r.units[t].leases=r.units[t].leases.filter(function(e,t){return!_.isEmpty(e)&&e}),r.units[t].leases.length<1&&delete r.units[t].leases}),r},parseKeyErrors:function(e){var t=e.map(function(e){return JSON.stringify(e)}),a=_.uniq(t);return a=a.map(function(e){return JSON.parse(e)})},displayMessage:function(e,t){var a=$('<div class="success"></div>');a.text(e);var s=this.$el.find(".messages");s.append(a)},displayErrorMessage:function(e,t){var a=this,s="";if(this.$el.find(".file-drop").removeClass("loading"),"object"==typeof e)for(var r in e){if(t){var n=$('<div class="error"><pre></pre></div>');n.children("pre").text(JSON.stringify(t,void 0,2)),a.$el.find(".messages").append(n)}s="message"==r?e[r]:r+": "+e[r]}else s=e;var i=$('<div class="error strong">'+s+"</div>");a.$el.find(".messages").append(i)},displayKeyErrors:function(e){var t=this;this.$el.find(".file-drop").removeClass("loading"),e.forEach(function(e){var a="";for(var s in e)a+='Invalid key "'+e[s]+'"" at '+s;t.$el.find(".messages").append($('<div class="error">'+a+"</div>"))})},findVal:function(e,t){for(var a in t)if("object"==typeof t[a]&&t[a].h==e)return a},getLocation:function(e,t){return this.findVal(e,t)},getModelType:function(e){return this.propertyFields.some(function(t){return t in e})?"property":this.unitFields.some(function(t){return t in e})?"unit_lease":!!this.tenantFields.some(function(t){return t in e})&&"tenant"},validateAll:function(e){var t=this,a=!0;if(e.forEach(function(e){e||(a=!1)}),!a)return!1;if(this.displayMessage("Data parsed successful, validating..."),e=e.map(function(e){return t.validateModel(e,"property"),e.units&&(e.units=e.units.map(function(e){return e=t.validateModel(e,"unit"),e.leases&&(e.leases=e.leases.map(function(e){return e=t.validateModel(e,"lease"),e.tenants&&(e.tenants=e.tenants.map(function(e){return t.validateModel(e,"tenant"),e})),e})),e})),e}),this.errors)return!1;this.data=e;setTimeout(function(){t.displayMessage("Validation successful, processing...")},700);this.verifyData()},validateModel:function(n,i){var o;switch(i){case"property":o=new t;break;case"unit":o=new a,_.extend(o.validation,{property:{required:!1}});break;case"lease":o=new s,_.extend(o.validation,{unit:{required:!1}});break;case"tenant":o=new r}var l=e.schema.process(n,o);o.set(l),_.extend(o,Backbone.Validation.mixin);var d=o.validate();return d?(this.errors=!0,this.displayErrorMessage(d,n),delete o,!1):(console.log(l),this.queue[i].push(o),delete o,l)},verifyData:function(){var t=this;if(0===this.queue.length)return void this.displayErrorMessage({queue_empty:"No data in queue"});var a=this.queue;for(var s in a){console.log(s,a[s]);var r=a[s].length,n=1===r?s:e.utils.modelNames(s,!0),i=r+" "+n,o=[];a[s].forEach(function(e){o.push(JSON.stringify(e.toJSON(),void 0,2))}),this.displayMessage(i,o.join(", "))}var l=setTimeout(function(){t.$el.find(".file-drop").removeClass("loading"),t.$el.find(".import").fadeOut(600,function(){t.$el.addClass("processed"),t.showSummary()}),clearTimeout(l)},1200)},promptSave:function(){var t="test",a="Are you sure you want to import "+t+"?";e.controls.modalConfirm(a,"confirmSave",this)},submitData:function(){e.controls.loadLock(!0),console.log(this.data),this.sendData({data:this.data}).then(function(){console.log(arguments),e.controls.loadLock(!1),e.router.navigate("properties",{trigger:!0}),e.alerts.success("Data imported successfully!")}).fail(function(t){console.warn(arguments),e.alerts.error("Could not import data"),e.controls.loadLock(!1)})},sendData:function(t,a){return e.utils.request({path:"import",method:"POST",data:t.data,refresh:!0},a)},showSummary:function(){this.$el.find(".summary-table").html(this.template_summary({properties:this.data}))},resetView:function(){delete this.data;var e=this;this.$el.find(".messages").html(""),this.$el.removeClass("processed"),this.$el.find("form")[0].reset(),this.filesChosen();var t=setTimeout(function(){e.$el.find(".summary-table").html(""),e.$el.find(".import").fadeIn(600),clearTimeout(t)},600)}})});
//# sourceMappingURL=Data.js.map
