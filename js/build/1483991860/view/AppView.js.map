{"version":3,"sources":["view/AppView.js"],"names":["define","app","AppTemplate","Backbone","View","extend","className","template","_","initialize","this","on","modalOpened","modalClosed","session","load","render","roleClass","role","get","$el","addClass","deviceIsSupported","map","superadmin","desktop","mobile","admin","manager","tenant","landlord","device","utils","isMobile","support","val","renderNotSupported","suggestion","data","each","supported","i","msg","$outer_container","$","$container","$description","text","append","templates","logo","html","removeClass","_route","_id","self","deferred","Deferred","router","checkAuth","then","views","loginView","close","appView","prepend","isOnboarded","renderActivation","isSuperAdmin","collections","companies","loadCollection","CompaniesCollection","fetch","navView","renderNav","currentModel","renderView","resolve","fail","index","css","match","join","navigate","trigger","replace","promise","find","route","capitalize","modelView","currentView","console","log","loadView","subPage","renderSecondary","unitsView","unitView","e","warn","renderModel","id","reject","models","superadmins","admins","managers","tenants","landlords","properties","units","leases","bills","ledger","rentroll","mybill","myleases","view","parentModelId","selected","renderTertiary","delegateEvents","renderUnit","uid","renderQuarternary","NavView","renderedContent","activateView","ActivateView","attr","removeAttr","modalView"],"mappings":"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","file":"AppView.js","sourcesContent":["/**\n * AppView.js\n */\n\ndefine([\n  'app',\n  'text!templates/app.html'\n  // 'view/NavView'\n],\nfunction(app, AppTemplate) {\n\n  return Backbone.View.extend({\n\n    className: 'app',\n\n    template: _.template(AppTemplate),\n\n    initialize: function() {\n      this.on('modalOpened', this.modalOpened, this);\n      this.on('modalClosed', this.modalClosed, this);\n      app.session.on('change:logged_in', this.load, this);\n    },\n    \n    // on login change, redirect\n    load: function() {\n      this.render('dashboard');\n    },\n\n    roleClass: function() {\n      var role = app.session.get('user_role');\n      this.$el.addClass('role-' + role);\n    },\n\n    deviceIsSupported: function() {\n      var map = {\n        superadmin: {\n          desktop: true,\n          mobile: true\n        },\n        admin: {\n          desktop: true,\n          mobile: true\n        },\n        manager: {\n          desktop: true,\n          mobile: false\n        },\n        tenant: {\n          desktop: true,\n          mobile: true\n        },\n        landlord: {\n          desktop: false,\n          mobile: true\n        }\n      };\n      var device = app.utils.isMobile() ? 'mobile' : 'desktop';\n      var role = app.session.get('user_role');\n\n      return { \n        role: role, \n        device: device, \n        support: map[role],\n        val: map[role][device], \n      };\n    },\n\n    renderNotSupported: function() {\n      var data = this.deviceIsSupported();\n      var suggestion;\n      _.each(data.support, function(supported, i) {\n        if (supported) suggestion = i;\n      });\n\n      var msg = 'Sorry, the ' + data.role + ' app is not currently supported on ' + data.device + '. ';\n\n      msg += 'Please use a ' + suggestion + ' device.';\n      var $outer_container = $('<div class=\"not-supported\" />');\n      var $container = $('<div class=\"container\" />');\n      var $description = $('<div class=\"description\" />');\n\n      $description.text(msg);\n      $container.append(app.templates.logo());\n      $container.append($description);\n      $outer_container.append($container);\n\n      $('main').html($outer_container);\n      $('body').removeClass('loading');\n    },\n\n    render: function(_route, _id) {\n      var self = this;\n      var deferred = $.Deferred();\n\n      app.router.checkAuth().then(function() {\n\n        if (app.views.loginView) {\n          app.views.loginView.close();\n          delete app.views.loginView;\n        }\n\n        if (!self.deviceIsSupported().val) return self.renderNotSupported();\n\n        // first time build after log in\n        if (!app.views.appView) {\n\n          app.views.appView = self;\n          self.$el.html(self.template());\n          self.$el.prepend(app.templates.logo());\n\n          // check if the user is onboarded\n          if (!app.session.isOnboarded()) self.renderActivation();\n\n          // if admin, load companies collection\n          if (app.session.isSuperAdmin() && !app.collections.companies) {\n            app.utils.loadCollection.get('companies/CompaniesCollection').then(function(CompaniesCollection) {\n              app.collections.companies = new CompaniesCollection();\n              app.collections.companies.fetch();\n            });\n          }\n        }\n\n        // check if nav is rendered\n        if (!self.navView) self.navView = self.renderNav();\n\n        // add role class to app element\n        self.roleClass();\n\n        // determine which view to load\n        self.currentModel = _route;\n\n        self.renderView(self.currentModel, _id).then(function() {\n          $('body').removeClass('loading');\n          deferred.resolve();\n        });\n\n      }).fail(function() {\n        // close AppView & log out\n        \n        self.$el.removeClass(function(index, css) {\n          return (css.match (/(^|\\s)role-\\S+/g) || []).join(' ');\n        });\n        \n        self.close();\n        self.navView = false;\n        app.router.appView = false;\n        app.router.navigate('/', { trigger: true, replace: true });\n\n        deferred.resolve();\n      });\n      return deferred.promise();\n    },\n\n    renderView: function(_route, _id) {\n      this.$el.find('.secondary').addClass('loading');\n      \n      if (!_route) return false;\n\n      // files are case sensitive on Linux HD formatting :P\n      var route = app.utils.capitalize(_route);\n\n      var self = this;\n      var view;\n      var deferred = $.Deferred();\n      \n      if (app.views.modelView) delete app.views.modelView;\n      if (app.views.currentView) delete app.views.currentView;\n\n      console.log(route)\n      \n      app.utils.loadView.get(route + 'View').then(function(View) {\n        app.views.currentView = new View({ subPage: _id });\n        self.renderSecondary(app.views.currentView.$el);\n\n        if (app.views.unitsView) delete app.views.unitsView;\n        if (app.views.unitView) delete app.views.unitView;\n\n        return deferred.resolve();\n      }).fail(function(e) {\n        console.warn(e);\n      });\n\n      return deferred.promise();\n    },\n\n    // renderOverlay: function(_route, _id) {\n    //   // console.log(_route, _id);\n    //   app.utils.loadView.get(_route + 'View').then(function(View) {\n    //     new View({ _id: _id });\n    //   });\n    // },\n\n    renderModel: function(_route, id) {\n      this.$el.find('.tertiary').addClass('loading');\n      var self = this;\n      var deferred = $.Deferred();\n\n      if (!_route) return deferred.reject();\n\n      // console.log(_route, id)\n\n      var models = {\n        // 'users': 'user',\n        'superadmins': 'user',\n        'admins': 'user',\n        'managers': 'user',\n        'tenants': 'user',\n        'landlords': 'user',\n        'companies': 'company',\n        'properties': 'property',\n        'units': 'units', // loads a nested collection view\n        'leases': 'lease',\n        'bills': 'bill',\n        'ledger': 'ledgerEntry',\n        'rentroll': 'rentrollEntry',\n        'mybill': 'mybill',\n        'myleases': 'mylease'\n      };\n\n      var route = app.utils.capitalize(models[_route]);\n\n      app.utils.loadView.get(route + 'View').then(function(View) {\n        var view;\n\n        // clear out active views\n        if (app.views.modelView) {\n          app.views.modelView.close();\n          delete app.views.modelView;\n        }\n\n        if (app.views.unitView) {\n          app.views.unitView.close();\n          delete app.views.unitView;\n        }\n\n        if (app.views.unitsView) {\n          app.views.unitsView.close();\n          delete app.views.unitsView;\n        }\n\n        // UnitsView\n        if (route === 'Units') {\n          app.views.unitsView = new View({\n            parentModelId: id\n          });\n          view = app.views.unitsView;\n\n        // ModelView\n        } else {\n          app.views.modelView = new View({ _id: id });\n          view = app.views.modelView;\n        }\n        \n        // store active model id, view\n        app.views.currentView.selected = id;\n\n        // render the view and set up events\n        self.renderTertiary(view.$el);\n        view.delegateEvents();\n\n        return deferred.resolve();\n      });\n\n      return deferred.promise();\n    },\n\n    renderUnit: function(id, uid) {\n      this.$el.find('.quarternary').addClass('loading');\n\n      var self = this;\n      if (app.views.unitView) {\n        app.views.unitView.close();\n        delete app.views.unitView;\n      }\n\n      app.utils.loadView.get('UnitView').then(function(View) {\n        app.views.unitView = new View({\n          parentModelId: id,\n          _id: uid\n        });\n        if (app.views.unitView && app.views.unitsView) {\n          app.views.unitsView.selected = uid;\n          self.renderQuarternary(app.views.unitView.$el);\n          app.views.unitsView.$el.find('.table-container .row[data-id=\"' + uid + '\"]').addClass('selected');\n        }\n      });\n    },\n\n    renderNav: function() {\n      var self = this;\n\n      app.utils.loadView.get('nav/' + app.session.get('user_role')).then(function(NavView) {\n        var navView = new NavView();\n        self.$el.find('.primary').html(navView.$el);\n        // events get super messed up if you try to append this.$el to the dom before nav is loaded\n        $('main').html(self.$el);\n      });\n      return true;\n    },\n\n    renderSecondary: function(renderedContent) {\n      $('body').addClass('tertiary-hidden quarternary-hidden');\n      console.log('removing loading class')\n\n      \n      this.$el.find('.secondary').html(renderedContent).removeClass('loading');\n      return true;\n    },\n\n    renderTertiary: function(renderedContent) {\n      this.$el.find('.tertiary').html(renderedContent);\n      $('body').removeClass('tertiary-hidden');\n      return true;\n    },\n\n    renderQuarternary: function(renderedContent) {\n      this.$el.find('.quarternary').html(renderedContent);\n      $('body').removeClass('quarternary-hidden');\n      return true;\n    },\n\n    renderActivation: function() {\n      var self = this;\n      if (app.views.activateView) {\n        app.views.activateView.close();\n        delete app.views.activateView;\n      }\n\n      app.utils.loadView.get('account/Activate').then(function(ActivateView) {\n        app.views.activateView = new ActivateView();\n        self.$el.append(app.views.activateView.$el);\n      });\n    },\n\n    modalOpened: function() {\n      $('body').addClass('modal-open');\n\n      // trap user focus to just inside the modal\n      this.$el.find('input:not(:disabled), a').addClass('nofocus').attr('tabindex', '-1');\n    },\n\n    modalClosed: function() {\n      $('body').removeClass('modal-open');\n\n      // untrap user focus\n      this.$el.find('.nofocus').removeClass('nofocus').removeAttr('tabindex');\n\n      if (app.views.modalView) delete app.views.modalView;\n    }\n\n  });\n});"]}