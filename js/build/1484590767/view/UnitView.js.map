{"version":3,"sources":["view/UnitView.js"],"names":["define","app","Kalendae","TenantModel","UnitModel","ModalLeaseView","LeaseCardView","UnitTemplate","HeaderTemplate","Backbone","View","extend","_","Events","className","events","click .action-close","click .action-edit","click .action-cancel","click .action-save","click .action-delete","click .action-add-lease","click .action-back","template","template_container","initialize","options","this","self","model","_id","parentModelId","Validation","bind","fetch","then","render","attachEvents","on","saveModel","deleteModel","clearModal","listening","data","toJSON","header_info","get","$el","html","header","find","unit","leases","each","lease","tenants","tenant","tenantModel","push","lease_card","parentView","append","delay","setTimeout","$","removeClass","addClass","clearTimeout","toggleEdit","$btn","$actions","parent","$form","hasClass","prop","cancelEdit","constructData","formData","serializeObject","schema","process","console","log","save","route","router","getPath","split","pop","join","controls","hideQuarternary","trigger","navigate","e","warn","promptSave","utils","validate","target","message","modalConfirm","promptDelete","event","override","promise","Deferred","destroy","getRoute","resolve","fail","error","handleError","reject","closePanel","addLease","modal","action","context","eventName","editLease","view","renewLease"],"mappings":"AAIAA,QACE,MACA,WACA,0BACA,6BACA,6BACA,mBACA,iCACA,2DAEF,SAASC,EAAKC,EAAUC,EAAaC,EAAWC,EAAgBC,EAAeC,EAAcC,GAE3F,MAAOC,UAASC,KAAKC,OAAOC,EAAED,UAAWF,SAASI,QAEhDC,UAAW,uBAEXC,QACEC,sBAAuB,aACvBC,qBAAsB,aACtBC,uBAAwB,aACxBC,qBAAsB,aACtBC,uBAAwB,eACxBC,0BAA2B,WAC3BC,qBAAsB,cAGxBC,SAAUX,EAAEW,SAAShB,GACrBiB,mBAAoBZ,EAAEW,SAASf,GAE/BiB,WAAY,SAASC,GACnBd,EAAED,OAAOgB,KAAMD,EACf,IAAIE,GAAOD,IAEXA,MAAKE,MAAQ,GAAIzB,IACf0B,IAAKH,KAAKG,MAEVC,cAAeJ,KAAKI,gBAGtBtB,SAASuB,WAAWC,KAAKN,MAEzBA,KAAKE,MAAMK,QAAQC,KAAK,WACtBP,EAAKQ,YAITC,aAAc,WACZV,KAAKW,GAAG,cAAeX,KAAKY,UAAWZ,MACvCA,KAAKW,GAAG,gBAAiBX,KAAKa,YAAab,MAC3CA,KAAKW,GAAG,eAAgBX,KAAKF,WAAYE,MACzCA,KAAKW,GAAG,cAAeX,KAAKF,WAAYE,MACxCA,KAAKW,GAAG,eAAgBX,KAAKF,WAAYE,MACzCA,KAAKW,GAAG,cAAeX,KAAKc,WAAYd,MACxCA,KAAKe,WAAY,GAGnBN,OAAQ,WACDT,KAAKe,WAAWf,KAAKU,cAC1B,IAAIT,GAAOD,KACPgB,EAAOhB,KAAKE,MAAMe,SAElBC,GACFhB,MAAOF,KAAKE,MAAMiB,IAAI,iBAGxBnB,MAAKoB,IAAIC,KAAKrB,KAAKH,oBAAqByB,OAAQJ,KAChDlB,KAAKoB,IAAIG,KAAK,aAAaF,KAAKrB,KAAKJ,UAAW4B,KAAMR,KAEtDhB,KAAKyB,OAASzB,KAAKE,MAAMiB,IAAI,UAE7BlC,EAAEyC,KAAK1B,KAAKyB,OAAQ,SAASE,GAE3B,GAAIC,KAEJ3C,GAAEyC,KAAKC,EAAMC,QAAS,SAASC,GAC7B,GAAIC,GAAc,GAAItD,GAAYqD,EAClCD,GAAQG,KAAKD,EAAYb,WAG3B,IAAIe,GAAa,GAAIrD,IACnBqC,KAAMW,EACNC,QAASA,EACTK,WAAYhC,GAGdA,GAAKmB,IAAIG,KAAK,SAASW,OAAOF,EAAWZ,MAK3C,IAAIe,GAAQC,WAAW,WACrBC,EAAE,QAAQC,YAAY,mBACtBrC,EAAKmB,IAAImB,SAAS,UAClBC,aAAaL,IACZ,GAIH,OAFAE,GAAE,gBAAgBC,YAAY,WAEvBtC,MAGTyC,WAAY,WACV,GAAIC,GAAO1C,KAAKoB,IAAIG,KAAK,gBACrBoB,EAAWD,EAAKE,SAASA,SACzBC,EAAQ7C,KAAKoB,IAAIG,KAAK,kBAEtBsB,GAAMC,SAAS,YACjBH,EAASL,YAAY,WACrBO,EAAMP,YAAY,WAClBO,EAAMtB,KAAK,SAASwB,KAAK,YAAY,KAErCJ,EAASJ,SAAS,WAClBM,EAAMN,SAAS,WACfM,EAAMtB,KAAK,SAASwB,KAAK,YAAY,KAIzCC,WAAY,WACVhD,KAAKS,UAGPwC,cAAe,WACb,GAAIJ,GAAQ7C,KAAKoB,IAAIG,KAAK,QACtB2B,EAAWL,EAAMM,iBAErB,OAAO7E,GAAI8E,OAAOC,QAAQH,EAAUlD,KAAKE,QAG3CU,UAAW,WACT,GACIsC,GAAWlD,KAAKiD,eAEpBK,SAAQC,IAAIL,GAGZlD,KAAKE,MAAMsD,KAAKN,GAAU1C,KAAK,WAC7B,GAAIiD,GAAQnF,EAAIoF,OAAOC,UAAUC,MAAM,IACvCH,GAAMI,MACNJ,EAAQA,EAAMK,KAAK,KACnBxF,EAAIyF,SAASC,iBACXC,SAAS,IAEX3F,EAAIoF,OAAOQ,SAAST,GAASQ,SAAS,KACrC,SAASE,GACVb,QAAQc,KAAKD,MAIjBE,WAAY,WACV,IAAK/F,EAAIgG,MAAMC,SAASvE,MAAO,OAAO,CAEtC,IAAIwE,GAASxE,KAAKE,MAAMiB,IAAI,UACxBsD,EAAU,4BAA8BD,EAAS,+CAErDlG,GAAIyF,SAASW,aAAaD,EAAS,cAAezE,OAGpD2E,aAAc,WACZ,GAAIH,GAASxE,KAAKE,MAAMiB,IAAI,UACxBsD,EAAU,oCAAsCD,EAAS,GAE7DlG,GAAIyF,SAASW,aAAaD,EAAS,gBAAiBzE,OAKtDa,YAAa,SAAS+D,EAAOC,GAC3B,GAAI5E,GAAOD,KACP8E,EAAUzC,EAAE0C,UAYhB,OAVA/E,MAAKE,MAAM8E,UAAUxE,KAAK,WACxB,GAAIiD,GAAQnF,EAAIoF,OAAOuB,UAEvB,OADA3G,GAAIoF,OAAOQ,SAAST,GAASQ,SAAS,IAC/Ba,EAAQI,YAEdC,KAAK,SAASC,GAEf,MADKP,IAAUvG,EAAIyF,SAASsB,YAAYD,EAAO,KAAMnF,EAAM,eACpD6E,EAAQQ,OAAOF,KAGjBN,GAGTS,WAAY,WACVjH,EAAIyF,SAASC,iBACXC,SAAS,KAIbuB,SAAU,WACRxF,KAAKyF,MAAQ,GAAI/G,IACfgH,OAAQ,MAGRC,QAAS3F,KACT4F,UAAW,kBAKfC,UAAW,SAASC,GAClB9F,KAAKyF,MAAQ,GAAI/G,IACfgH,OAAQ,OAGRC,QAAS3F,KACT4F,UAAW,cACX1F,MAAO4F,EAAK5F,SAKhB6F,WAAY,SAASD,GACnB9F,KAAKyF,MAAQ,GAAI/G,IACfgH,OAAQ,QAGRC,QAAS3F,KACT4F,UAAW,eACX1F,MAAO4F,EAAK5F,SAKhBY,WAAY,iBACHd,MAAKyF","file":"UnitView.js","sourcesContent":["/**\n * UnitView.js\n */\n\ndefine([\n  'app',\n  'kalendae',\n  'model/users/TenantModel',\n  'model/properties/UnitModel',\n  'view/modals/ModalLeaseView',\n  'view/cards/lease',\n  'text!templates/units/unit.html',\n  'text!templates/headers/header-tertiary-panel-model.html',\n],\nfunction(app, Kalendae, TenantModel, UnitModel, ModalLeaseView, LeaseCardView, UnitTemplate, HeaderTemplate) {\n\n  return Backbone.View.extend(_.extend({}, Backbone.Events, {\n\n    className: 'model-view unit-view',\n\n    events: {\n      'click .action-close': 'closePanel',\n      'click .action-edit': 'toggleEdit',\n      'click .action-cancel': 'cancelEdit',\n      'click .action-save': 'promptSave',\n      'click .action-delete': 'promptDelete',\n      'click .action-add-lease': 'addLease',\n      'click .action-back': 'closePanel'\n    },\n\n    template: _.template(UnitTemplate),\n    template_container: _.template(HeaderTemplate),\n\n    initialize: function(options) {\n      _.extend(this, options);\n      var self = this;\n\n      this.model = new UnitModel({\n        _id: this._id,\n      }, { \n        parentModelId: this.parentModelId\n      });\n\n      Backbone.Validation.bind(this);\n\n      this.model.fetch().then(function() {\n        self.render();\n      });\n    },\n\n    attachEvents: function() {\n      this.on('confirmSave', this.saveModel, this);\n      this.on('confirmDelete', this.deleteModel, this);\n      this.on('leaseCreated', this.initialize, this);\n      this.on('leaseEdited', this.initialize, this);\n      this.on('leaseRenewed', this.initialize, this);\n      this.on('modalClosed', this.clearModal, this);\n      this.listening = true;\n    },\n\n    render: function() {\n      if (!this.listening) this.attachEvents();\n      var self = this;\n      var data = this.model.toJSON();\n\n      var header_info = {\n        model: this.model.get('number_pretty')\n      };\n\n      this.$el.html(this.template_container({ header: header_info }));\n      this.$el.find('.scroll-y').html(this.template({ unit: data }));\n\n      this.leases = this.model.get('leases');\n\n      _.each(this.leases, function(lease) {\n\n        var tenants = [];\n\n        _.each(lease.tenants, function(tenant) {\n          var tenantModel = new TenantModel(tenant);\n          tenants.push(tenantModel.toJSON());\n        });\n        \n        var lease_card = new LeaseCardView({\n          data: lease,\n          tenants: tenants,\n          parentView: self\n        });\n\n        self.$el.find('.grid').append(lease_card.$el);\n      });\n\n      // $('.table-container .row[data-id=\"' + this._id + '\"]').addClass('selected');\n\n      var delay = setTimeout(function() {\n        $('body').removeClass('tertiary-hidden');\n        self.$el.addClass('active');\n        clearTimeout(delay);\n      }, 90);\n\n      $('.quarternary').removeClass('loading');\n\n      return this;\n    },\n\n    toggleEdit: function() {\n      var $btn = this.$el.find('.action-edit');\n      var $actions = $btn.parent().parent();\n      var $form = this.$el.find('form.form-model');\n\n      if ($form.hasClass('editing')) {\n        $actions.removeClass('editing');\n        $form.removeClass('editing');\n        $form.find('input').prop('disabled', true);\n      } else {\n        $actions.addClass('editing');\n        $form.addClass('editing');\n        $form.find('input').prop('disabled', false);\n      }\n    },\n\n    cancelEdit: function() {\n      this.render();\n    },\n\n    constructData: function() {\n      var $form = this.$el.find('form');\n      var formData = $form.serializeObject();\n\n      return app.schema.process(formData, this.model);\n    },\n\n    saveModel: function() {\n      var self = this;\n      var formData = this.constructData();\n\n      console.log(formData);\n\n      // Save to server\n      this.model.save(formData).then(function() {\n        var route = app.router.getPath().split('/');\n        route.pop();\n        route = route.join('/');\n        app.controls.hideQuarternary({\n          trigger: false\n        });\n        app.router.navigate(route, { trigger: true });\n      }, function(e) {\n        console.warn(e);\n      });\n    },\n\n    promptSave: function() {\n      if (!app.utils.validate(this)) return false;\n\n      var target = this.model.get('number');\n      var message = 'You have made changes to ' + target + '. Are you sure you want to save your changes?';\n\n      app.controls.modalConfirm(message, 'confirmSave', this);\n    },\n\n    promptDelete: function() {\n      var target = this.model.get('number');\n      var message = 'Are you sure you want to delete #' + target + '?';\n\n      app.controls.modalConfirm(message, 'confirmDelete', this);\n\n      // app.controls.promptDelete(message, 'confirmDelete', this);\n    },\n\n    deleteModel: function(event, override) {\n      var self = this;\n      var promise = $.Deferred();\n\n      this.model.destroy().then(function() {\n        var route = app.router.getRoute();\n        app.router.navigate(route, { trigger: true });\n        return promise.resolve();\n\n      }).fail(function(error) {\n        if (!override) app.controls.handleError(error, null, self, 'deleteModel');\n        return promise.reject(error);\n      });\n\n      return promise;\n    },\n\n    closePanel: function() {\n      app.controls.hideQuarternary({\n        trigger: true\n      });\n    },\n\n    addLease: function() {\n      this.modal = new ModalLeaseView({\n        action: 'add',\n        // unit: this.model,\n        // parentModelId: this.parentModelId,\n        context: this,\n        eventName: 'leaseCreated',\n        // leases: this.leases\n      });\n    },\n\n    editLease: function(view) {\n      this.modal = new ModalLeaseView({\n        action: 'edit',\n        // unit: this.model, \n        // parentModelId: this.parentModelId,\n        context: this, \n        eventName: 'leaseEdited',\n        model: view.model,\n        // leases: this.leases\n      });\n    },\n\n    renewLease: function(view) {\n      this.modal = new ModalLeaseView({\n        action: 'renew',\n        // unit: this.model,\n        // parentModelId: this.parentModelId, \n        context: this, \n        eventName: 'leaseRenewed',\n        model: view.model,\n        // leases: this.leases\n      });\n    },\n\n    clearModal: function() {\n      delete this.modal;\n    }\n\n  }));\n});"]}