define(["app","text!templates/app.html"],function(e,i){return Backbone.View.extend({className:"app",template:_.template(i),initialize:function(){this.on("modalOpened",this.modalOpened,this),this.on("modalClosed",this.modalClosed,this),e.session.on("change:logged_in",this.load,this)},load:function(){this.render("dashboard")},roleClass:function(){var i=e.session.get("user_role");this.$el.addClass("role-"+i)},deviceIsSupported:function(){var i={superadmin:{desktop:!0,mobile:!0},admin:{desktop:!0,mobile:!0},manager:{desktop:!0,mobile:!1},tenant:{desktop:!0,mobile:!0},landlord:{desktop:!1,mobile:!0}},t=e.utils.isMobile()?"mobile":"desktop",n=e.session.get("user_role");return{role:n,device:t,support:i[n],val:i[n][t]}},renderNotSupported:function(){var i,t=this.deviceIsSupported();_.each(t.support,function(e,t){e&&(i=t)});var n="Sorry, the "+t.role+" app is not currently supported on "+t.device+". ";n+="Please use a "+i+" device.";var s=$('<div class="not-supported" />'),r=$('<div class="container" />'),o=$('<div class="description" />');o.text(n),r.append(e.templates.logo()),r.append(o),s.append(r),$("main").html(s),$("body").removeClass("loading")},render:function(i,t){var n=this,s=$.Deferred();return e.router.checkAuth().then(function(){return e.views.loginView&&(e.views.loginView.close(),delete e.views.loginView),n.deviceIsSupported().val?(e.views.appView||(e.views.appView=n,n.$el.html(n.template()),n.$el.prepend(e.templates.logo()),e.session.isOnboarded()||n.renderActivation(),e.session.isSuperAdmin()&&!e.collections.companies&&e.utils.loadCollection.get("companies/CompaniesCollection").then(function(i){e.collections.companies=new i,e.collections.companies.fetch()})),n.navView||(n.navView=n.renderNav()),n.roleClass(),n.currentModel=i,void n.renderView(n.currentModel,t).then(function(){$("body").removeClass("loading"),s.resolve()})):n.renderNotSupported()}).fail(function(){n.$el.removeClass(function(e,i){return(i.match(/(^|\s)role-\S+/g)||[]).join(" ")}),n.close(),n.navView=!1,e.router.appView=!1,e.router.navigate("/",{trigger:!0,replace:!0}),s.resolve()}),s.promise()},renderView:function(i,t){if(this.$el.find(".secondary").addClass("loading"),!i)return!1;var n=e.utils.capitalize(i),s=this,r=$.Deferred();return e.views.modelView&&delete e.views.modelView,e.views.currentView&&delete e.views.currentView,console.log(n),e.utils.loadView.get(n+"View").then(function(i){return e.views.currentView=new i({subPage:t}),s.renderSecondary(e.views.currentView.$el),e.views.unitsView&&delete e.views.unitsView,e.views.unitView&&delete e.views.unitView,r.resolve()}).fail(function(e){console.warn(e)}),r.promise()},renderModel:function(i,t){this.$el.find(".tertiary").addClass("loading");var n=this,s=$.Deferred();if(!i)return s.reject();var r={superadmins:"user",admins:"user",managers:"user",tenants:"user",landlords:"user",companies:"company",properties:"property",units:"units",leases:"lease",bills:"bill",ledger:"ledgerEntry",rentroll:"rentrollEntry",mybill:"mybill",myleases:"mylease"},o=e.utils.capitalize(r[i]);return e.utils.loadView.get(o+"View").then(function(i){var r;return e.views.modelView&&(e.views.modelView.close(),delete e.views.modelView),e.views.unitView&&(e.views.unitView.close(),delete e.views.unitView),e.views.unitsView&&(e.views.unitsView.close(),delete e.views.unitsView),"Units"===o?(e.views.unitsView=new i({parentModelId:t}),r=e.views.unitsView):(e.views.modelView=new i({_id:t}),r=e.views.modelView),e.views.currentView.selected=t,n.renderTertiary(r.$el),r.delegateEvents(),s.resolve()}),s.promise()},renderUnit:function(i,t){this.$el.find(".quarternary").addClass("loading");var n=this;e.views.unitView&&(e.views.unitView.close(),delete e.views.unitView),e.utils.loadView.get("UnitView").then(function(s){e.views.unitView=new s({parentModelId:i,_id:t}),e.views.unitView&&e.views.unitsView&&(e.views.unitsView.selected=t,n.renderQuarternary(e.views.unitView.$el),e.views.unitsView.$el.find('.table-container .row[data-id="'+t+'"]').addClass("selected"))})},renderNav:function(){var i=this;return e.utils.loadView.get("nav/"+e.session.get("user_role")).then(function(e){var t=new e;i.$el.find(".primary").html(t.$el),$("main").html(i.$el)}),!0},renderSecondary:function(e){return $("body").addClass("tertiary-hidden quarternary-hidden"),console.log("removing loading class"),this.$el.find(".secondary").html(e).removeClass("loading"),!0},renderTertiary:function(e){return this.$el.find(".tertiary").html(e),$("body").removeClass("tertiary-hidden"),!0},renderQuarternary:function(e){return this.$el.find(".quarternary").html(e),$("body").removeClass("quarternary-hidden"),!0},renderActivation:function(){var i=this;e.views.activateView&&(e.views.activateView.close(),delete e.views.activateView),e.utils.loadView.get("account/Activate").then(function(t){e.views.activateView=new t,i.$el.append(e.views.activateView.$el)})},modalOpened:function(){$("body").addClass("modal-open"),this.$el.find("input:not(:disabled), a").addClass("nofocus").attr("tabindex","-1")},modalClosed:function(){$("body").removeClass("modal-open"),this.$el.find(".nofocus").removeClass("nofocus").removeAttr("tabindex"),e.views.modalView&&delete e.views.modalView}})});
//# sourceMappingURL=AppView.js.map
