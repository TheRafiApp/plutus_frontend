define(["app","model/account/AccountModel"],function(e,t){var s=Backbone.Model.extend({defaults:{logged_in:!1,user_role:null},tokens:{},initialize:function(){this.updateAjaxSetup(),e.models.AccountModel=t,this.user=new t,this.bind("change:logged_in",this.updateSession,this)},url:function(){return e.API()},isSuperAdmin:function(){return"superadmin"==this.get("user_role")},isAdmin:function(){return"admin"==this.get("user_role")},isManager:function(){return"manager"==this.get("user_role")},isTenant:function(){return"tenant"==this.get("user_role")},isLandlord:function(){return"landlord"==this.get("user_role")},isOnboarded:function(t){if(e.config.debug&&e.utils.stash.getItem("bypass-activation"))return!0;var s=t||e.session.user.toJSON();if(["superadmin"].contains(s.role))return!0;var i=e.utils.getOnboardingSteps(s);return!!i&&!i.some(function(e){return!e.value})},setTokens:function(t){return t.authorization&&e.utils.stash.setItem("authorization",t.authorization),t.refresh&&e.utils.stash.setItem("refresh",t.refresh),t.activation&&e.utils.stash.setItem("activation",t.activation),this.updateAjaxSetup(),this},updateSession:function(){e.utils.stash.removeItem("activation"),this.get("logged_in")?(this.tokens={},this.set("user_role",this.user.get("role"))):(e.utils.stash.setItem("last-login",this.user.get("email")||this.user.get("phone")),e.utils.stash.removeItem("authorization"),e.utils.stash.removeItem("refresh"),this.user.clear().set(this.user.defaults),e.collections.companies&&(e.collections.companies.reset(),delete e.collections.companies),e.views.accountView&&(e.views.accountView.model.clear(),delete e.views.accountView),e.views.appView&&(e.views.appView.close(),delete e.views.appView),e.views.activateView&&(e.views.activateView.close(),delete e.views.activateView),e.views.currentView&&(e.views.currentView.close(),delete e.views.currentView))},updateAjaxSetup:function(){var t=this;$.ajaxSetup({contentType:"application/json",dataType:"json",beforeSend:function(s){t.injectHeader(s,"Authorization",e.utils.stash.getItem("authorization"));var i=e.utils.stash.getItem("activation");i&&t.injectHeader(s,"Activation",i),t.tokens.pass&&t.injectHeader(s,"Password",t.tokens.pass)}})},updateSessionUser:function(e){this.user.set(e),this.setTokens({authorization:e.session.authorization_token,refresh:e.session.refresh_token})},injectHeader:function(e,t,s){var i=s;return s||(i=""),e.setRequestHeader(t,i),e},login:function(t,s){t||(t={});var i=!!t.refresh;return e.utils.request({path:"users/login",method:"POST",data:t.data,refresh:i},s)},logout:function(t){return e.utils.request({path:"users/logout",method:"POST",refresh:!0},t)},refresh:function(t,s){return t||(t={}),e.utils.request({path:"users/tokens",method:"GET",data:t.data,refresh:!0},s)},postPassword:function(t,s){return e.utils.request({data:t,path:"users/password",method:"POST"},s)},putPassword:function(t,s){return e.utils.request({data:t,path:"users/password",method:"PUT"},s)},setPassword:function(t,s){return e.utils.request({data:t,path:"users/activate/password",method:"POST"},s)},verifyCode:function(t,s){return e.utils.request({data:t,path:"users/contact",method:"PUT"},s)},verifyAuthentication:function(t,s){var i=this,n=e.utils.request({data:t,path:"users/activate/contact",method:"PUT"},s);return n.then(function(e){e.session&&e.session.activation_token&&i.setTokens({activation:e.session.activation_token})}),n},requestAuthentication:function(t,s){return e.utils.request({data:t,path:"users/activate/contact",method:"POST"},s)},updateLease:function(t,s){return e.utils.request({data:t,path:"users/activate/leases",method:"PUT"},s)},declineInvitation:function(t,s){return e.utils.request({data:t,path:"users/activate/decline",method:"POST"},s)},refreshTokens:function(){var t=this,s=new $.Deferred;return e.utils.request({path:"users/tokens",method:"GET",refresh:!0}).then(function(e){return t.updateSessionUser(e||{}),s.resolve(e)}).fail(function(t){return e.router.navigate("/",{trigger:!0,replace:!0}),s.reject(t)}),s}});return s});
//# sourceMappingURL=SessionModel.js.map
