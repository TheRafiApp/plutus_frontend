{"version":3,"sources":["view/UnitsView.js"],"names":["define","app","PropertyModel","UnitsCollection","TableUnitView","ModalUnitView","ModalPropertyView","TableContainerTemplate","TableCollectionHeader","TableUnitTemplate","Backbone","View","extend","className","events","click .action-add","click .action-edit","click .action-save","click .action-delete","click .sub-header-target","click .action-back","click .action-show-tips","click .action-sort","keyup .search-field","search .search-field","tips","header","body","link","template","_","template_header","template_container","attachEvents","this","on","batchSave","deleteModel","clearModal","modelAdded","refresh","renderTips","listening","views","currentView","initialize","alerts","success","_options","self","parentModel","_id","parentModelId","model","fetch","then","collection","response","collection_backup","clone","error","indexOf","render","responseJSON","message","queue","$el","html","find","renderTable","addClass","unitView","$","removeClass","property","length","header_info","get","count","modelPlural","model_plural","utils","capitalize","title","$table","append","each","unit","table_unit_view","parentView","TipsView","selector","context","showTips","show","toggleEdit","$btn","$actions","parent","hasClass","prop","cancelEdit","constructData","data","child_views","$user_row","$inputs","x","key","attr","value","val","push","sortCollection","event","searchCollection","query","target","search","addUnit","modal","action","eventName","editProperty","promptDelete","controls","modalConfirm","promptSave","override","promise","Deferred","destroy","route","router","getRoute","navigate","trigger","resolve","fail","handleError","reject","hideQuarternary","hideTertiary"],"mappings":"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","file":"UnitsView.js","sourcesContent":["/**\n * UnitsView.js\n */\n\ndefine([\n  'app',\n  'model/properties/PropertyModel',\n  'collection/properties/UnitsCollection',\n  'view/tables/TableUnitView',\n  'view/modals/ModalUnitView',\n  'view/modals/ModalPropertyView',\n  'text!templates/tables/table-container-collection-units.html',\n  'text!templates/tables/table-collection-headers.html',\n  'text!templates/tables/table-units.html',\n],\nfunction(\n  app, \n  PropertyModel, \n  UnitsCollection, \n  TableUnitView, \n  ModalUnitView, \n  ModalPropertyView, \n  TableContainerTemplate, \n  TableCollectionHeader, \n  TableUnitTemplate\n  ) {\n\n  return Backbone.View.extend({\n\n    className: 'collection-view table-view',\n\n    events: {\n      'click .action-add': 'addUnit',\n      'click .action-edit': 'editProperty',\n      'click .action-save': 'promptSave',\n      'click .action-delete': 'promptDelete',\n      'click .sub-header-target': 'hideQuarternary',\n      'click .action-back': 'hideTertiary',\n      'click .action-show-tips': 'showTips',\n      'click .action-sort': 'sortCollection',\n      'keyup .search-field': 'searchCollection',\n      'search .search-field': 'searchCollection',\n    },\n\n    tips: [\n      'Proin quis hendrerit justo, a vehicula nulla. Proin vulputate facilisis turpis ut lobortis. Proin molestie mattis justo eget posuere. Duis sed odio feugiat, interdum diam sed',\n      'Ut tincidunt metus vel libero cursus pellentesque. Sed tincidunt, turpis ac efficitur egestas, tellus nibh iaculis purus, in aliquam elit eros nec elit.',\n      { \n        'header': 'Writing emails',\n        'body': 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Quisque efficitur, dui ut fringilla placerat, enim arcu lacinia odio, at dictum risus purus vitae ante.',\n        'link': 'http://google.com'\n      },\n      'Sed tempus, eros et tempus egestas, sem diam iaculis nisl, ac ultricies lacus nunc sit amet nisl. Suspendisse lectus nulla, rhoncus non mauris nec, varius consequat felis.'\n    ],\n\n\n    template: _.template(TableUnitTemplate),\n    template_header: _.template(TableCollectionHeader),\n    template_container: _.template(TableContainerTemplate),\n\n    attachEvents: function() {\n      this.on('batchSave', this.batchSave, this);\n      this.on('confirmDelete', this.deleteModel, this);\n      this.on('modalClosed', this.clearModal, this);\n      this.on('unitAdded', this.modelAdded, this);\n      this.on('unitEdited', this.refresh, this);\n\n      this.renderTips();\n\n      this.listening = true;\n    },\n\n    refresh: function() {\n      app.views.currentView.initialize();\n      this.initialize();\n    },\n\n    modelAdded: function() {\n      this.refresh();\n      app.alerts.success('Unit added successfully');\n    },\n\n    initialize: function(_options) {\n      if (_options) _.extend(this, _options);\n\n      var self = this;\n\n      this.parentModel = new PropertyModel({\n        _id: this.parentModelId\n      });\n\n      this.model = this.parentModel;\n\n      this.parentModel.fetch().then(function() {\n        self.collection = new UnitsCollection(null, {\n          parentModelId: self.parentModelId\n        });\n        self.collection.fetch().then(function(response) {\n          self.collection_backup = self.collection.clone();\n\n          if (response && response.error) {\n            if (response.error.indexOf('not_found') > -1) {\n              self.render();\n            }\n          } else {\n            self.render();\n          }\n        }, function(error) {\n          app.alerts.error(error.responseJSON.message);\n        });\n      }, function(error) {\n        app.alerts.error(error.responseJSON.message);\n      });\n\n    },\n\n    render: function() {\n      if (!this.listening) this.attachEvents();\n      this.queue = [];\n\n      var self = this;\n\n      // Build the table\n      this.$el.html(this.template_container());\n      this.$el.find('.table-container').html(this.template());\n\n      this.renderTable();\n\n      var clone = this.$el.find('.table').clone();\n\n      // Fixed header hack\n      this.$el.find('.sub-header').html(clone);\n\n      app.views.currentView.$el.find('.row[data-id=\"' + this.parentModelId + '\"]').addClass('selected');\n\n      if (app.views.unitView) {\n        this.$el.find('.table-container .row[data-id=\"' + app.views.unitView._id + '\"]').addClass('selected');\n      }\n\n      $('.tertiary').removeClass('loading');\n\n      return this;\n    },\n\n    renderTable: function() {\n      var self = this;\n      var property = this.parentModel;\n      var message = false;\n\n      if (this.collection.length < 1) message = 'No units found';\n\n      var header_info = {\n        property: property.get('name') || property.get('address'),\n        model: 'Unit',\n        count: this.collection.length\n      };\n\n      if (this.modelPlural) header_info.model_plural = app.utils.capitalize(this.modelPlural);\n\n      this.$el.find('.meta').html(this.template_header({\n        header: header_info,\n        title: this.title\n      }));\n\n      var $table = this.$el.find('.tbody');\n      $table.html('');\n\n      if (message) $table.append($('<div class=\"none-found\">' + message + '</div>'));\n\n      this.collection.each(function(unit) {\n\n        var table_unit_view = new TableUnitView({\n          model: unit,\n          parentView: self,\n          parentModel: self.parentModel\n        });\n\n        $table.append(table_unit_view.$el);\n      });\n    },\n\n    renderTips: function() {\n      var self = this;\n\n      var TipsView = app.View.TipsView;\n\n      this.tips = new TipsView({\n        selector: '.tertiary',\n        context: this\n      });\n    },\n\n    showTips: function() {\n      this.tips.show();\n    },\n\n    toggleEdit: function() {\n      var $btn = this.$el.find('.action-edit');\n      \n      var $actions = $btn.parent().parent();\n      var $table = this.$el.find('.table');\n\n      if ($table.hasClass('editing')) {\n        $actions.removeClass('editing');\n        $table.removeClass('editing');\n        $table.find('input').prop('disabled', true);\n      } else {\n        $actions.addClass('editing');\n        $table.addClass('editing');\n        $table.find('input').prop('disabled', false);\n      }\n    },\n\n    cancelEdit: function() {\n      this.render();\n    },\n\n    constructData: function() {\n      var data = [];\n\n      _.each(this.child_views, function($user_row) {\n        var model = {};\n        var $inputs = $user_row.$el.find('input');\n\n        $.each($inputs, function(x) {\n          var key = $($inputs[x]).attr('name');\n          var value = $($inputs[x]).val();\n          model[key] = value;\n        });\n\n        data.push(model);\n      });\n\n      return data;\n    },\n\n    sortCollection: function(event) {\n      if (this.$el.find('.table').hasClass('editing')) this.render();\n\n      app.utils.sortCollection(event, this);\n    },\n\n    searchCollection: function(event) {\n      var query = $(event.target).val();\n      if (!query) {\n        this.collection = this.collection_backup;\n      } else {\n        this.collection = this.collection_backup.search(query);\n      }\n      this.sortCollection();\n    },\n\n    addUnit: function() {\n      this.modal = new ModalUnitView({\n        action: 'add',\n        eventName: 'unitAdded',\n        context: this\n      });\n    },\n\n    editProperty: function() {\n      this.modal = new ModalPropertyView({\n        action: 'edit',\n        model: this.parentModel,\n        eventName: 'unitEdited',\n        context: this\n      });\n    },\n\n    promptDelete: function() {\n      var target = this.model.get('address');\n      var message = 'Are you sure you want to delete ' + target + '?';\n\n      app.controls.modalConfirm(message, 'confirmDelete', this);\n    },\n\n    promptSave: function() {\n      var message = 'You have made changes to multiple units. Are you sure you want to save your changes?';\n      app.controls.modalConfirm(message, 'batchSave', this);\n    },\n\n    deleteModel: function(event, override) {\n      var self = this;\n      var promise = $.Deferred();\n\n      this.model.destroy().then(function() {\n        var route = app.router.getRoute();\n        app.router.navigate(route, { trigger: true });\n\n        promise.resolve();\n\n      }).fail(function(error) {\n        if (!override) app.controls.handleError(error, null, self, 'deleteModel');\n        promise.reject(error);\n      });\n\n      return promise;\n    },\n\n    clearModal: function() {\n      delete this.modal;\n    },\n\n    hideQuarternary: function() {\n      if (app.views.unitView) {\n        app.controls.hideQuarternary({\n          trigger: true\n        });\n      }\n    },\n\n    hideTertiary: function() {\n      app.controls.hideTertiary();\n    },\n\n  });\n});"]}