define(["app","kalendae","view/modals/ModalView","model/bills/BillModel","collection/users/TenantsCollection","collection/leases/LeasesCollection","view/repeaters/charge","view/properties/PropertyUnitsView","text!templates/users/tenants.html","text!templates/leases/leases.html","text!templates/modals/modal-bill.html"],function(e,t,n,s,a,r,l,d,o,c,h){return n.extend({events:{"click .choices a":"chooseOption","click .tabs a":"showTab","click .action-select-lease":"selectLease","click .action-add-charge":"addCharge","click .action-delete":"closeCharge"},charges:[],template:_.template(h),tabs:{address:"By Address",tenant:"By Tenant"},title:function(){return this.action+" Bill"},initialize:function(t){t&&_.extend(this,t);var n=this;this.model=new s,this.on("addressChanged",this.updateAddress,this);var i=e.utils.promises(2);this.tenants=new a(null,{action:"active"}),this.tenants.fetch().then(function(){i[0].resolve()}),this.leases=new r,this.leases.fetch().then(function(){i[1].resolve()}),$.when.apply($,i).then(function(){n.renderModalView()})},renderError:function(e){this.$el.find(".content").addClass("error").append($("<div />",{class:"error overlay"}).html($("<span />").text(e))),this.$el.find(".action-confirm").addClass("disabled")},render:function(){var e=this;this.ready(),this.PropertyUnitsView=new d({selected_property:this.property_id,selected_unit:this.unit_id,activeOnly:!0,context:this}),this.$el.find(".tab-address .property-units").html(this.PropertyUnitsView.$el);var t=this.tenants.toJSON();t=t.map(function(e){return[e.first_name+" "+e.last_name,e._id]}),this.$el.find(".tenant-search").autoComplete({minChars:2,source:function(e,n){e=e.toLowerCase();var s=t,a=[];for(i=0;i<s.length;i++)~s[i][0].toLowerCase().indexOf(e)&&a.push(s[i]);n(a)},renderItem:function(e,t){return'<div class="autocomplete-suggestion" data-val="'+e[0]+'" data-id="'+e[1]+'">'+e[0]+"</div>"},onSelect:function(t,n,s){var i=$(s).attr("data-id");e.renderTenantData(i)}});var n=this.$el.find("#due_date");return this.due_date=new Kalendae(n[0],{months:1,direction:"today-future",selected:moment()}),this.due_date.subscribe("change",function(t){e.populateDate(t)}),this.populateDate(),this.addCharge(),this},chooseOption:function(e){this.$el.find(".choices a").removeClass("active"),$(e.currentTarget).addClass("active")},updateAddress:function(){var e=this.PropertyUnitsView,t=e.properties;if(0===t.length)return void this.showError(".properties-group","No properties with units found.");var n=e.units;if(0===n.length)return void this.showError(".units-group","No units with active leases found.");var s=e.$el.find(".units").val(),i=n.where({_id:s}),a=new r(i[0].get("leases")),l=a.filter(function(e){return!!e.active});this.$el.find(".tab-address input.lease").val(""),l.length>0?(this.selected_lease=l[0],this.$el.find(".tab-address input.lease").val(l[0].id),this.renderTenants(".tab-address .tenants-select",l[0].get("tenants"))):this.showError(".tenants-group","Sorry, no active leases found.")},renderTenants:function(e,t){var n=_.template(o);this.$el.find(e).html(n({tenants:t,selected:!1})),this.$el.find(".chosen.tenants").chosen({width:"100%"})},renderTenantData:function(e){this.tenant_leases=this.findTenant(e);var t=_.template(c);this.$el.find(".tenants-select").html(""),this.$el.find(".leases").html(t({leases:this.tenant_leases}))},findTenant:function(e){var t=this.leases.toJSON(),n=t.filter(function(t){var n=t.tenants.find(function(t){return t._id===e});return!!n});return n},selectLease:function(e){var t=$(e.currentTarget).attr("data-id");this.$el.find(".tab-tenant input.lease").val(t),this.selected_lease=this.tenant_leases.find(function(e){return e._id===t}),this.renderTenants(".tab-tenant .tenants-select",this.selected_lease.tenants)},showError:function(e,t){this.$el.find(e).addClass("has-error").children(".help-text").html(t)},showTab:function(e,t){var n=$(e.currentTarget);if(!n.hasClass("active")){this.$el.find(".tabs a").removeClass("active"),n.addClass("active");var s=t||$(e.currentTarget).attr("data-tab");this.$el.find(".tab-content").hide(),this.$el.find(".tab-content select, .tab-content input").prop("disabled",!0),this.$el.find(".tab-content.tab-"+s).show(),this.$el.find(".tab-content.tab-"+s+" select, .tab-content.tab-"+s+" input").prop("disabled",!1)}},populateDate:function(e){e||(e=this.due_date.getSelectedRaw()[0].format("MM/DD/YYYY")),this.$el.find(".date-input").val(e),this.$el.find(".date-input").trigger("change")},constructData:function(){var t=this.$el.find("form"),n=t.serializeObject();delete n.unit;var s=moment.utc(n.due_date);return this.selected_lease.containsDate(s)||e.controls.fieldError({element:".date-input",error:"Due date is outside term of lease"}),e.schema.process(n,this.model)},chargeCounter:0,addCharge:function(){var e=new l({options:{type:"fee",description:!0},name:"charges.scheduled",id:this.chargeCounter++,context:this,min:1});this.charges.push(e),this.$el.find(".charges").append(e.$el)}})});
//# sourceMappingURL=ModalBillView.js.map
