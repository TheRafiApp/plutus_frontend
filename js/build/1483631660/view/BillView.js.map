{"version":3,"sources":["view/BillView.js"],"names":["define","app","UserCardView","ModalTransferView","BillModel","BillTemplate","HeaderTemplate","Backbone","View","extend","_","Events","className","events","click .action-add-transfer","click .action-delete","click .action-close","template","template_container","initialize","options","this","self","model","_id","Validation","bind","fetch","then","render","attachEvents","on","deleteModel","listening","data","toJSON","header_info","get","display_name","$el","html","header","delete","find","bill","prettyMoney","utils","tenants","transfers","each","tenant","tenant_id","amount","forEach","transfer","source","tenant_card","append","$","views","currentView","selected","addClass","removeClass","promptDelete","target","message","controls","modalConfirm","destroy","console","log","route","router","getRoute","navigate","trigger","fail","error","handleError","hideTertiary","modelView","addTransfer","modal","action","type","eventName","context"],"mappings":"AAIAA,QACE,MACA,2BACA,gCACA,wBACA,iCACA,qDAEF,SAASC,EAAKC,EAAcC,EAAmBC,EAAWC,EAAcC,GAEtE,MAAOC,UAASC,KAAKC,OAAOC,EAAED,UAAWF,SAASI,QAEhDC,UAAW,qBAEXC,QACEC,6BAA8B,cAI9BC,uBAAwB,eACxBC,sBAAuB,gBAGzBC,SAAUP,EAAEO,SAASZ,GACrBa,mBAAoBR,EAAEO,SAASX,GAE/Ba,WAAY,SAASC,GACnBV,EAAED,OAAOY,KAAMD,EACf,IAAIE,GAAOD,IAEXA,MAAKE,MAAQ,GAAInB,IAAYoB,IAAKH,KAAKG,MAEvCjB,SAASkB,WAAWC,KAAKL,MAEzBA,KAAKE,MAAMI,QAAQC,KAAK,WACtBN,EAAKO,YAITC,aAAc,WACZT,KAAKU,GAAG,gBAAiBV,KAAKF,WAAYE,MAC1CA,KAAKU,GAAG,gBAAiBV,KAAKW,YAAaX,MAC3CA,KAAKY,WAAY,GAGnBJ,OAAQ,WACN,GAAIP,GAAOD,IAENA,MAAKY,WAAWZ,KAAKS,cAE1B,IAAII,GAAOb,KAAKE,MAAMY,SAElBC,GACFb,MAAOF,KAAKE,MAAMc,IAAI,QAAU,WAAahB,KAAKE,MAAMe,eAG1DjB,MAAKkB,IAAIC,KAAKnB,KAAKH,oBACjBuB,OAAQL,EACRhB,SACEsB,SAAqC,WAA1BrB,KAAKE,MAAMc,IAAI,aAI9BhB,KAAKkB,IAAII,KAAK,aAAaH,KAAKnB,KAAKJ,UACnC2B,KAAMV,EACNW,YAAa5C,EAAI6C,MAAMD,eAGzBxB,KAAK0B,QAAU1B,KAAKE,MAAMc,IAAI,UAC9B,IAAIW,GAAY3B,KAAKE,MAAMc,IAAI,YAwB/B,OAtBA3B,GAAEuC,KAAK5B,KAAK0B,QAAS,SAASG,GAC5B,GAAIC,GAAYD,EAAO1B,IACnB4B,EAAS,CAEbJ,GAAUK,QAAQ,SAASC,GACrBA,EAASC,QAAUJ,IAAWC,GAAUE,EAASF,SAKvD,IAAII,GAAc,GAAItD,IACpBgC,KAAMgB,EACNE,OAAQA,GAGV9B,GAAKiB,IAAII,KAAK,mBAAmBc,OAAOD,EAAYjB,OAGtDmB,EAAE,iBAAmBzD,EAAI0D,MAAMC,YAAYC,SAAW,MAAMC,SAAS,YAErEJ,EAAE,aAAaK,YAAY,WAEpB1C,MAGT2C,aAAc,WACZ,GAAIC,GAAS5C,KAAKE,MAAMe,eACpB4B,EAAU,mCAAqCD,EAAS,GAE5DhE,GAAIkE,SAASC,aAAaF,EAAS,gBAAiB7C,OAGtDW,YAAa,WACXX,KAAKE,MAAM8C,UAAUzC,KAAK,WACxB0C,QAAQC,IAAI,UAGZ,IAAIC,GAAQvE,EAAIwE,OAAOC,UACvBzE,GAAIwE,OAAOE,SAASH,GAASI,SAAS,MACrCC,KAAK,SAASC,GACf7E,EAAI6C,MAAMiC,YAAYD,MAI1BE,aAAc,WACR/E,EAAI0D,MAAMsB,WAAWhF,EAAIkE,SAASa,gBAGxCE,YAAa,WACX7D,KAAK8D,MAAQ,GAAIhF,IACfiF,OAAQ,MACRC,KAAM,iBACNC,UAAW,gBACXC,QAASlE","file":"BillView.js","sourcesContent":["/**\n * BillView.js\n */\n\ndefine([\n  'app',\n  'view/cards/user_payments',\n  'view/modals/ModalTransferView',\n  'model/bills/BillModel',\n  'text!templates/bills/bill.html',\n  'text!templates/headers/header-tertiary-model.html',\n],\nfunction(app, UserCardView, ModalTransferView, BillModel, BillTemplate, HeaderTemplate) {\n\n  return Backbone.View.extend(_.extend({}, Backbone.Events, {\n\n    className: 'bill-view scroll-y',\n\n    events: {\n      'click .action-add-transfer': 'addTransfer',\n      // 'click .action-edit': 'toggleEdit',\n      // 'click .action-cancel': 'cancelEdit',\n      // 'click .action-save': 'promptSave',\n      'click .action-delete': 'promptDelete',\n      'click .action-close': 'hideTertiary'\n    },\n\n    template: _.template(BillTemplate),\n    template_container: _.template(HeaderTemplate),\n\n    initialize: function(options) {\n      _.extend(this, options);\n      var self = this;\n\n      this.model = new BillModel({ _id: this._id });\n\n      Backbone.Validation.bind(this);\n\n      this.model.fetch().then(function() {\n        self.render();\n      });\n    },\n\n    attachEvents: function() {\n      this.on('transferAdded', this.initialize, this);\n      this.on('confirmDelete', this.deleteModel, this);\n      this.listening = true;\n    },\n\n    render: function() {\n      var self = this;\n\n      if (!this.listening) this.attachEvents();\n\n      var data = this.model.toJSON();\n\n      var header_info = {\n        model: this.model.get('type') + ' Bill â€“ ' + this.model.display_name()\n      };\n\n      this.$el.html(this.template_container({\n        header: header_info,\n        options: {\n          delete: !!(this.model.get('type') == 'anytime')\n        }\n      }));\n\n      this.$el.find('.scroll-y').html(this.template({ \n        bill: data,\n        prettyMoney: app.utils.prettyMoney\n      }));\n\n      this.tenants = this.model.get('tenants');\n      var transfers = this.model.get('transfers');\n\n      _.each(this.tenants, function(tenant) {\n        var tenant_id = tenant._id; \n        var amount = 0;\n\n        transfers.forEach(function(transfer) {\n          if (transfer.source == tenant_id) amount += transfer.amount;\n        });\n\n        // console.log(tenant_transfers)\n\n        var tenant_card = new UserCardView({\n          data: tenant,\n          amount: amount\n        });\n\n        self.$el.find('.transfer-cards').append(tenant_card.$el);\n      });\n\n      $('.row[data-id=\"' + app.views.currentView.selected + '\"]').addClass('selected');\n\n      $('.tertiary').removeClass('loading');\n      \n      return this;\n    },\n\n    promptDelete: function() {\n      var target = this.model.display_name();\n      var message = 'Are you sure you want to delete ' + target + '?';\n\n      app.controls.modalConfirm(message, 'confirmDelete', this);\n    },\n\n    deleteModel: function() {\n      this.model.destroy().then(function() {\n        console.log('success')\n\n        \n        var route = app.router.getRoute();\n        app.router.navigate(route, { trigger: true });\n      }).fail(function(error) {\n        app.utils.handleError(error);\n      });\n    },\n\n    hideTertiary: function() {\n      if (app.views.modelView) app.controls.hideTertiary();\n    },\n\n    addTransfer: function() {\n      this.modal = new ModalTransferView({\n        action: 'add',\n        type: 'non-electronic',\n        eventName: 'transferAdded',\n        context: this,\n      });\n    }\n\n  }));\n});"]}