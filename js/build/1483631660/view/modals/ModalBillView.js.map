{"version":3,"sources":["view/modals/ModalBillView.js"],"names":["define","app","kalendae","ModalView","BillModel","TenantsCollection","LeasesCollection","ChargeRepeater","PropertyUnitsView","TenantsTemplate","LeasesTemplate","ModalBillTemplate","extend","events","click .choices a","click .tabs a","click .action-select-lease","click .action-add-charge","click .action-delete","charges","template","_","tabs","address","tenant","title","this","action","initialize","_options","self","model","on","updateAddress","promises","utils","tenants","fetch","then","resolve","leases","$","when","apply","renderModalView","renderError","error","$el","find","addClass","append","class","html","text","render","ready","selected_property","property_id","selected_unit","unit_id","activeOnly","context","toJSON","map","first_name","last_name","_id","autoComplete","minChars","source","term","suggest","toLowerCase","choices","matches","i","length","indexOf","push","renderItem","item","search","onSelect","e","tenant_id","attr","renderTenantData","$date_field","due_date","Kalendae","months","direction","selected","moment","subscribe","date","populateDate","addCharge","chooseOption","removeClass","currentTarget","propUnitsView","properties","showError","units","val","unit","where","get","active","filter","lease","selected_lease","id","renderTenants","selector","tenants_array","tenants_template","chosen","width","tenant_leases","findTenant","leases_template","match","selectLease","lease_id","message","children","showTab","tab","clicked","hasClass","tabName","hide","prop","show","getSelectedRaw","format","trigger","constructData","$form","formData","serializeObject","utc","containsDate","controls","fieldError","element","schema","process","chargeCounter","recurring_charge","options","type","description","name","min"],"mappings":"AAIAA,QACE,MACA,WACA,wBACA,wBACA,qCACA,qCACA,wBACA,oCACA,oCACA,oCACA,yCAEF,SACEC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,GAGA,MAAOR,GAAUS,QAEfC,QACEC,mBAAoB,eACpBC,gBAAiB,UACjBC,6BAA8B,cAC9BC,2BAA4B,YAC5BC,uBAAwB,eAG1BC,WAEAC,SAAUC,EAAED,SAAST,GAErBW,MACEC,QAAS,aACTC,OAAQ,aAGVC,MAAO,WACL,MAAOC,MAAKC,OAAS,SAGvBC,WAAY,SAASC,GACfA,GAAUR,EAAET,OAAOc,KAAMG,EAE7B,IAAIC,GAAOJ,IAEXA,MAAKK,MAAQ,GAAI3B,GAEjBsB,KAAKM,GAAG,iBAAkBN,KAAKO,cAAeP,KAE9C,IAAIQ,GAAWjC,EAAIkC,MAAMD,SAAS,EAElCR,MAAKU,QAAU,GAAI/B,GAAkB,MACnCsB,OAAQ,WAGVD,KAAKU,QAAQC,QAAQC,KAAK,WACxBJ,EAAS,GAAGK,YAGdb,KAAKc,OAAS,GAAIlC,GAClBoB,KAAKc,OAAOH,QAAQC,KAAK,WACvBJ,EAAS,GAAGK,YAGdE,EAAEC,KAAKC,MAAMF,EAAGP,GAAUI,KAAK,WAC7BR,EAAKc,qBAITC,YAAa,SAASC,GACpBpB,KAAKqB,IAAIC,KAAK,YACbC,SAAS,SACTC,OAAOT,EAAE,WACRU,MAAO,kBACNC,KAAKX,EAAE,YACPY,KAAKP,KAGRpB,KAAKqB,IAAIC,KAAK,mBAAmBC,SAAS,aAG5CK,OAAQ,WACN,GAAIxB,GAAOJ,IAEXA,MAAK6B,QAEL7B,KAAKlB,kBAAoB,GAAIA,IAC3BgD,kBAAmB9B,KAAK+B,YACxBC,cAAehC,KAAKiC,QACpBC,YAAY,EACZC,QAASnC,OAGXA,KAAKqB,IAAIC,KAAK,gCAAgCI,KAAK1B,KAAKlB,kBAAkBuC,IAE1E,IAAIX,GAAUV,KAAKU,QAAQ0B,QAE3B1B,GAAUA,EAAQ2B,IAAI,SAASvC,GAC7B,OAAQA,EAAOwC,WAAa,IAAMxC,EAAOyC,UAAWzC,EAAO0C,OAG7DxC,KAAKqB,IAAIC,KAAK,kBAAkBmB,cAC9BC,SAAU,EACVC,OAAQ,SAASC,EAAMC,GACrBD,EAAOA,EAAKE,aACZ,IAAIC,GAAUrC,EACVsC,IAEJ,KAAKC,EAAE,EAAGA,EAAEF,EAAQG,OAAQD,KACrBF,EAAQE,GAAG,GAAGH,cAAcK,QAAQP,IAAOI,EAAQI,KAAKL,EAAQE,GAEvEJ,GAAQG,IAEVK,WAAY,SAASC,EAAMC,GACzB,MAAO,kDAAoDD,EAAK,GAAK,cAAgBA,EAAK,GAAK,KAAOA,EAAK,GAAK,UAElHE,SAAU,SAASC,EAAGb,EAAMU,GAC1B,GAAII,GAAY3C,EAAEuC,GAAMK,KAAK,UAC7BvD,GAAKwD,iBAAiBF,KAI1B,IAAIG,GAAc7D,KAAKqB,IAAIC,KAAK,YAiBhC,OAbAtB,MAAK8D,SAAW,GAAIC,UAASF,EAAY,IACvCG,OAAQ,EACRC,UAAW,eACXC,SAAUC,WAGZnE,KAAK8D,SAASM,UAAU,SAAU,SAASC,GACzCjE,EAAKkE,aAAaD,KAGpBrE,KAAKsE,eACLtE,KAAKuE,YAEEvE,MAGTwE,aAAc,SAASf,GACrBzD,KAAKqB,IAAIC,KAAK,cAAcmD,YAAY,UACxC1D,EAAE0C,EAAEiB,eAAenD,SAAS,WAG9BhB,cAAe,WACb,GAAIoE,GAAgB3E,KAAKlB,kBAGrB8F,EAAaD,EAAcC,UAC/B,IAA0B,IAAtBA,EAAW1B,OAEb,WADAlD,MAAK6E,UAAU,oBAAqB,kCAKtC,IAAIC,GAAQH,EAAcG,KAC1B,IAAqB,IAAjBA,EAAM5B,OAER,WADAlD,MAAK6E,UAAU,eAAgB,qCAKjC,IAAI5C,GAAU0C,EAActD,IAAIC,KAAK,UAAUyD,MAG3CC,EAAOF,EAAMG,OAAQzC,IAAKP,IAG1BnB,EAAS,GAAIlC,GAAiBoG,EAAK,GAAGE,IAAI,WAG1CC,EAASrE,EAAOsE,OAAO,SAASC,GAClC,QAAOA,EAAMF,QAGfnF,MAAKqB,IAAIC,KAAK,4BAA4ByD,IAAI,IAE1CI,EAAOjC,OAAS,GAClBlD,KAAKsF,eAAiBH,EAAO,GAC7BnF,KAAKqB,IAAIC,KAAK,4BAA4ByD,IAAII,EAAO,GAAGI,IACxDvF,KAAKwF,cAAc,+BAAgCL,EAAO,GAAGD,IAAI,aAGjElF,KAAK6E,UAAU,iBAAkB,mCAIrCW,cAAe,SAASC,EAAUC,GAChC,GAAIC,GAAmBhG,EAAED,SAASX,EAClCiB,MAAKqB,IAAIC,KAAKmE,GAAU/D,KAAKiE,GAC3BjF,QAASgF,EACTxB,UAAU,KAEZlE,KAAKqB,IAAIC,KAAK,mBAAmBsE,QAC/BC,MAAO,UAIXjC,iBAAkB,SAASF,GACzB1D,KAAK8F,cAAgB9F,KAAK+F,WAAWrC,EAErC,IAAIsC,GAAkBrG,EAAED,SAASV,EAEjCgB,MAAKqB,IAAIC,KAAK,mBAAmBI,KAAK,IAEtC1B,KAAKqB,IAAIC,KAAK,WAAWI,KAAKsE,GAC5BlF,OAAQd,KAAK8F,kBAIjBC,WAAY,SAASrC,GACnB,GAAI5C,GAASd,KAAKc,OAAOsB,SACrB0D,EAAgBhF,EAAOsE,OAAO,SAASC,GACzC,GAAIY,GAAQZ,EAAM3E,QAAQY,KAAK,SAASxB,GACtC,MAAOA,GAAO0C,MAAQkB,GAExB,SAAOuC,GAGT,OAAOH,IAGTI,YAAa,SAASzC,GACpB,GAAI0C,GAAWpF,EAAE0C,EAAEiB,eAAef,KAAK,UAEvC3D,MAAKqB,IAAIC,KAAK,2BAA2ByD,IAAIoB,GAE7CnG,KAAKsF,eAAiBtF,KAAK8F,cAAcxE,KAAK,SAAS+D,GACrD,MAAOA,GAAM7C,MAAQ2D,IAGvBnG,KAAKwF,cAAc,8BAA+BxF,KAAKsF,eAAe5E,UAGxEmE,UAAW,SAASY,EAAUW,GAC5BpG,KAAKqB,IAAIC,KAAKmE,GAAUlE,SAAS,aAAa8E,SAAS,cAAc3E,KAAK0E,IAG5EE,QAAS,SAAS7C,EAAG8C,GACnB,GAAIC,GAAUzF,EAAE0C,EAAEiB,cAClB,KAAI8B,EAAQC,SAAS,UAArB,CAEAzG,KAAKqB,IAAIC,KAAK,WAAWmD,YAAY,UACrC+B,EAAQjF,SAAS,SAEjB,IAAImF,GAAUH,GAAOxF,EAAE0C,EAAEiB,eAAef,KAAK,WAC7C3D,MAAKqB,IAAIC,KAAK,gBAAgBqF,OAC9B3G,KAAKqB,IAAIC,KAAK,2CAA2CsF,KAAK,YAAY,GAE1E5G,KAAKqB,IAAIC,KAAK,oBAAsBoF,GAASG,OAC7C7G,KAAKqB,IAAIC,KAAK,oBAAsBoF,EAAU,6BAA+BA,EAAU,UAAUE,KAAK,YAAY,KAGpHtC,aAAc,SAASD,GAChBA,IAAMA,EAAOrE,KAAK8D,SAASgD,iBAAiB,GAAGC,OAAO,eAC3D/G,KAAKqB,IAAIC,KAAK,eAAeyD,IAAIV,GACjCrE,KAAKqB,IAAIC,KAAK,eAAe0F,QAAQ,WAGvCC,cAAe,WACb,GAAIC,GAAQlH,KAAKqB,IAAIC,KAAK,QAEtB6F,EAAWD,EAAME,wBAGdD,GAASnC,IAGhB,IAAIlB,GAAWK,OAAOkD,IAAIF,EAASrD,SASnC,OAPK9D,MAAKsF,eAAegC,aAAaxD,IACpCvF,EAAIgJ,SAASC,YACXC,QAAS,cACTrG,MAAO,sCAIJ7C,EAAImJ,OAAOC,QAAQR,EAAUnH,KAAKK,QAG3CuH,cAAe,EAEfrD,UAAW,WACT,GAAIsD,GAAmB,GAAIhJ,IACzBiJ,SACEC,KAAM,MACNC,aAAa,GAEfC,KAAM,oBACN1C,GAAIvF,KAAK4H,gBACTzF,QAASnC,KACTkI,IAAK,GAGPlI,MAAKP,QAAQ2D,KAAKyE,GAClB7H,KAAKqB,IAAIC,KAAK,YAAYE,OAAOqG,EAAiBxG","file":"ModalBillView.js","sourcesContent":["/**\n * ModalBillView.js\n */\n\ndefine([\n  'app',\n  'kalendae',\n  'view/modals/ModalView',\n  'model/bills/BillModel',\n  'collection/users/TenantsCollection',\n  'collection/leases/LeasesCollection',\n  'view/repeaters/charge',\n  'view/properties/PropertyUnitsView',\n  'text!templates/users/tenants.html',\n  'text!templates/leases/leases.html',\n  'text!templates/modals/modal-bill.html'\n],\nfunction(\n  app, \n  kalendae, \n  ModalView,\n  BillModel, \n  TenantsCollection, \n  LeasesCollection, \n  ChargeRepeater, \n  PropertyUnitsView, \n  TenantsTemplate, \n  LeasesTemplate, \n  ModalBillTemplate \n) {\n\n  return ModalView.extend({\n\n    'events': {\n      'click .choices a': 'chooseOption',\n      'click .tabs a': 'showTab',\n      'click .action-select-lease': 'selectLease',\n      'click .action-add-charge': 'addCharge',\n      'click .action-delete': 'closeCharge'\n    },\n\n    charges: [],\n\n    template: _.template(ModalBillTemplate),\n\n    tabs: {\n      address: 'By Address',\n      tenant: 'By Tenant'\n    },\n\n    title: function() {\n      return this.action + ' Bill';\n    },\n\n    initialize: function(_options) {\n      if (_options) _.extend(this, _options);\n\n      var self = this;\n\n      this.model = new BillModel();\n\n      this.on('addressChanged', this.updateAddress, this);\n\n      var promises = app.utils.promises(2);\n\n      this.tenants = new TenantsCollection(null, {\n        action: 'active'\n      });\n\n      this.tenants.fetch().then(function() {\n        promises[0].resolve();\n      });\n\n      this.leases = new LeasesCollection();\n      this.leases.fetch().then(function() {\n        promises[1].resolve();\n      });\n\n      $.when.apply($, promises).then(function() {\n        self.renderModalView();\n      });\n    },\n\n    renderError: function(error) {\n      this.$el.find('.content')\n      .addClass('error')\n      .append($('<div />', {\n        class: 'error overlay'\n      }).html($('<span />')\n        .text(error)\n      ));\n\n      this.$el.find('.action-confirm').addClass('disabled');\n    },\n\n    render: function() {\n      var self = this;\n\n      this.ready();\n\n      this.PropertyUnitsView = new PropertyUnitsView({\n        selected_property: this.property_id,\n        selected_unit: this.unit_id,\n        activeOnly: true,\n        context: this\n      });\n\n      this.$el.find('.tab-address .property-units').html(this.PropertyUnitsView.$el);\n\n      var tenants = this.tenants.toJSON();\n\n      tenants = tenants.map(function(tenant) {\n        return [tenant.first_name + ' ' + tenant.last_name, tenant._id];\n      });\n\n      this.$el.find('.tenant-search').autoComplete({\n        minChars: 2,\n        source: function(term, suggest) {\n          term = term.toLowerCase();\n          var choices = tenants;\n          var matches = [];\n\n          for (i=0; i<choices.length; i++)\n            if (~choices[i][0].toLowerCase().indexOf(term)) matches.push(choices[i]);\n\n          suggest(matches);\n        },\n        renderItem: function(item, search) {\n          return '<div class=\"autocomplete-suggestion\" data-val=\"' + item[0] + '\" data-id=\"' + item[1] + '\">' + item[0] + '</div>';\n        },\n        onSelect: function(e, term, item) {\n          var tenant_id = $(item).attr('data-id');\n          self.renderTenantData(tenant_id);\n        }\n      });\n\n      var $date_field = this.$el.find('#due_date');\n\n      // Init Kalendae\n\n      this.due_date = new Kalendae($date_field[0], {\n        months: 1,\n        direction: 'today-future',\n        selected: moment()\n      });\n\n      this.due_date.subscribe('change', function(date) {\n        self.populateDate(date);\n      });\n\n      this.populateDate();\n      this.addCharge();\n\n      return this;\n    },\n\n    chooseOption: function(e) {\n      this.$el.find('.choices a').removeClass('active');\n      $(e.currentTarget).addClass('active');\n    },\n\n    updateAddress: function() {\n      var propUnitsView = this.PropertyUnitsView;\n\n      // check if properties exist\n      var properties = propUnitsView.properties;\n      if (properties.length === 0) {\n        this.showError('.properties-group', 'No properties with units found.');\n        return;\n      }\n\n      // check if units exist\n      var units = propUnitsView.units;\n      if (units.length === 0) {\n        this.showError('.units-group', 'No units with active leases found.');\n        return;\n      }\n\n      // get selected unit id\n      var unit_id = propUnitsView.$el.find('.units').val();\n\n      // get the model with that id\n      var unit = units.where({ _id: unit_id });\n\n      // get the units leases\n      var leases = new LeasesCollection(unit[0].get('leases'));\n\n      // make sure the leases are active\n      var active = leases.filter(function(lease) {\n        return lease.active ? true : false;\n      });\n\n      this.$el.find('.tab-address input.lease').val('');\n\n      if (active.length > 0) {\n        this.selected_lease = active[0];\n        this.$el.find('.tab-address input.lease').val(active[0].id);\n        this.renderTenants('.tab-address .tenants-select', active[0].get('tenants'));\n      } else {\n        // if unit has leases but none are active, this probably wont happen anymore\n        this.showError('.tenants-group', 'Sorry, no active leases found.');\n      }\n    },\n\n    renderTenants: function(selector, tenants_array) {\n      var tenants_template = _.template(TenantsTemplate);\n      this.$el.find(selector).html(tenants_template({\n        tenants: tenants_array,\n        selected: false\n      }));\n      this.$el.find('.chosen.tenants').chosen({\n        width: '100%'\n      });\n    },\n\n    renderTenantData: function(tenant_id) {\n      this.tenant_leases = this.findTenant(tenant_id);\n\n      var leases_template = _.template(LeasesTemplate);\n      \n      this.$el.find('.tenants-select').html('');\n\n      this.$el.find('.leases').html(leases_template({\n        leases: this.tenant_leases\n      }));\n    },\n\n    findTenant: function(tenant_id) {\n      var leases = this.leases.toJSON();\n      var tenant_leases = leases.filter(function(lease) {\n        var match = lease.tenants.find(function(tenant) {\n          return tenant._id === tenant_id;\n        });\n        return match ? true : false;\n      });\n\n      return tenant_leases;\n    },\n\n    selectLease: function(e) {\n      var lease_id = $(e.currentTarget).attr('data-id');\n\n      this.$el.find('.tab-tenant input.lease').val(lease_id);\n\n      this.selected_lease = this.tenant_leases.find(function(lease) {\n        return lease._id === lease_id;\n      });\n\n      this.renderTenants('.tab-tenant .tenants-select', this.selected_lease.tenants);\n    },\n\n    showError: function(selector, message) {\n      this.$el.find(selector).addClass('has-error').children('.help-text').html(message);\n    },\n\n    showTab: function(e, tab) {\n      var clicked = $(e.currentTarget);\n      if (clicked.hasClass('active')) return;\n\n      this.$el.find('.tabs a').removeClass('active');\n      clicked.addClass('active');\n\n      var tabName = tab || $(e.currentTarget).attr('data-tab');\n      this.$el.find('.tab-content').hide();\n      this.$el.find('.tab-content select, .tab-content input').prop('disabled', true);\n\n      this.$el.find('.tab-content.tab-' + tabName).show();\n      this.$el.find('.tab-content.tab-' + tabName + ' select, .tab-content.tab-' + tabName + ' input').prop('disabled', false);\n    },\n\n    populateDate: function(date) {\n      if (!date) date = this.due_date.getSelectedRaw()[0].format('MM/DD/YYYY');\n      this.$el.find('.date-input').val(date);\n      this.$el.find('.date-input').trigger('change');\n    },\n\n    constructData: function() {\n      var $form = this.$el.find('form');\n\n      var formData = $form.serializeObject();\n\n      // we dont't want unit, but propertUnitsView needs it for lease creation\n      delete formData.unit;\n\n      // make sure due date is within lease term\n      var due_date = moment.utc(formData.due_date);\n\n      if (!this.selected_lease.containsDate(due_date)) {\n        app.controls.fieldError({\n          element: '.date-input',\n          error: 'Due date is outside term of lease'\n        });\n      }\n\n      return app.schema.process(formData, this.model);\n    },\n\n    chargeCounter: 0,\n\n    addCharge: function() {\n      var recurring_charge = new ChargeRepeater({\n        options: {\n          type: 'fee',\n          description: true\n        },\n        name: 'charges.scheduled',\n        id: this.chargeCounter++,\n        context: this,\n        min: 1\n      });\n\n      this.charges.push(recurring_charge);\n      this.$el.find('.charges').append(recurring_charge.$el);\n    }\n\n  });\n});"]}