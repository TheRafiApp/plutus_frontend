define(["app","kalendae","view/modals/ModalView","model/leases/LeaseModel","view/repeaters/charge","collection/users/TenantsCollection","text!templates/modals/modal-lease.html"],function(t,e,n,a,s,i,d){return n.extend({events:{"click .action-add-recurring":"addRecurring","click .action-add-scheduled":"addScheduled","click .overlay":"easyClose","change select.type":"typeChange","keyup .bill_due_day":"updateOrdinal","change #first":"toggleFirst","change #last":"toggleLast","keyup input.rent":"rentChanged"},title:function(){return this.action+" Lease"},template:_.template(d),recurring_charges:[],scheduled_charges:[],start_moment:!1,end_moment:!1,tenants:new i,hasTouch:t.utils.hasTouch(),initialize:function(e){e&&_.extend(this,e),this.action||(this.action="add");var n=this;this.unit=this.context.model,this.parentModelId=this.context.parentModelId,this.leases=this.context.leases,this.parentModelId&&(this.property=t.collections.currentCollection.get({_id:this.parentModelId})),this.model||(this.model=new a),this.on("calendar-open",this.calendarOpen,this),this.tenants.fetch().then(function(){n.renderModalView()})},calendarOpen:function(){var e=this.$el.find(".kalendae-input-open"),n=e.siblings("input"),a=this.$el.find(".content"),s=a.scrollTop(),i=e.closest(".field-group:not(.bypass)").position(),d=a.outerHeight(),r=e.parent().outerHeight(),o=e.outerHeight(),h=r+o,l=s+d,c=h+i.top;c>l&&(a.scrollTop(i.top),t.controls.wait(20).then(function(){n.focus()}))},render:function(){var e=this,n=this.tenants.toJSON();if(t.session.isSuperAdmin()){var a=this.property.get("company");n=JSON.parse(JSON.stringify(this.tenants.where({company:a})))}var s,d,r=!1,o=!1,h=this.model.get("first_month"),l=this.model.get("last_month");switch(this.action){case"add":s=moment.utc().add("months",1).startOf("month").startOf("day"),d=moment.utc().add("months",12);break;case"edit":s=this.model.get("start_moment"),d=this.model.get("end_moment"),d||(d=this.model.get("isActive")?moment.utc():moment.utc(s).add("months",12).subtract("days",1)),r=new i(this.model.get("tenants")).pluck("_id");break;case"renew":if(s=this.model.get("end_moment").add("days",1),d=moment.utc(s).add("months",12).subtract("days",1),r=new i(this.model.get("tenants")).pluck("_id"),l){var c=moment.utc(l.date),u=moment.utc();u>c&&(o=!0)}}this.ready({action:t.utils.capitalize(this.action),unit:this.unit.toJSON(),property:this.property.toJSON(),tenants:n,selected_tenants:r,last_month_passed:o,first_month:h,last_month:l});var m=this.$el.find("#start_date"),p=this.$el.find("#end_date"),g=[],f=[];if(_.each(this.leases,function(t){t.start_date=moment.utc(t.start_date),"fixed_term"==t.type?(t.end_date=moment.utc(t.end_date),g.push(t)):f.push(t)}),this.hasTouch?(this.start_date=m,this.end_date=p,this.start_date.attr("type","date").val(s.format("YYYY-MM-DD")),this.end_date.attr("type","date").val(d.format("YYYY-MM-DD")),this.start_date.on("change",$.proxy(this.typeChange,this)),this.end_date.on("change",function(){$.proxy(e.endChange(),e)})):(this.start_date=new Kalendae.Input(m[0],{months:1,selected:s,blackout:function(t){return e.blackout(t,g)},rangeClass:function(t){return e.rangeClass(t,f)}}),this.end_date=new Kalendae.Input(p[0],{months:1,mode:"range",rangeLock:!0,direction:"select-future",selected:[s,d],blackout:function(t){return e.blackout(t,g)},rangeClass:function(t){return e.rangeClass(t,f)}}),this.start_date.subscribe("change",function(){e.typeChange()}),this.start_date.subscribe("show",function(){e.trigger("calendar-open")}),this.end_date.subscribe("change",function(t){e.endChange()}),this.end_date.subscribe("show",function(){e.trigger("calendar-open")})),this.typeChange(),this.$el.find("input").change($.proxy(this.formChanged,this)),this.$el.find("select").change($.proxy(this.formChanged,this)),"add"!=this.action){var v=this.model.get("charges"),y=v.recurring;if(y.forEach(function(t){"rent"!=t.type&&e.addRecurring(null,t.amount)}),"renew"!=this.action){var b=v.scheduled;b.forEach(function(t){["fee","credit"].contains(t.type)&&e.addScheduled(null,t.amount,t.date)})}}return this.$el.find(".bill_due_day").mask("00"),this.$el.find(".rent, .first_month, .last_month").mask("zzzzzzz",{translation:{z:{pattern:/[0-9\.]/}}}),this},blackout:function(t,e){t=moment.utc(t);var n=!1;return e.every(function(e){var a=e.start_date,s=e.end_date,i=a<=t&&t<=s;return!i||(n=!0,!1)}),!!n},rangeClass:function(t,e){var n=!0;return e.every(function(e){var a,s=e.start_date,i=self.start_moment;return a=i&&i>s?s<=t&&t<i:t>=s,!a||(n=!1,!1)}),!n&&"k-month-to-month"},rentChanged:function(){var t=this.$el.find(".rent").val();t?this.toggleFees(!0):this.toggleFees(!1)},updateDueDay:function(){var e,n=this.$el.find(".bill_due_day");if(e=t.utils.hasTouch()?moment.utc(this.start_date.val()):this.start_date.getSelectedRaw()[0]){e=e.format("D");var a=e>28?28:e;n.val(a),this.updateOrdinal()}},updateOrdinal:function(){var e,n=this.$el.find(".bill_due_day"),a=n.val();a>28?(e=28,t.controls.fieldError({element:n,message:"Billing date must be a day that is shared by all months in the year"})):e=a,n.val(e);var s=t.utils.getOrdinal(e);this.$el.find("#ordinal").html(s)},toggleFee:function(t,e){var n=t.siblings(".money").children("input");if(e){if(t.prop("checked")){var a=this.$el.find(".rent").val();n.val(a),n.prop("disabled",!1)}}else n.prop("disabled",!0),n.val("0.00")},toggleFees:function(t,e){var n=this;"undefined"==typeof e&&(e="");var a=this.$el.find(".fee"+e);if(t){a.find(".toggle").prop("disabled",!1);var s=this.$el.find(".rent").val();_.each(a,function(t){n.toggleFee($(t).children(".toggle"),!0),$(t).children(".toggle").prop("checked")===!0&&$(t).children(".money input").val(s)})}else this.toggleFee(a.children(".toggle"),!1),a.find(".toggle").prop("disabled",!0),a.find(".toggle").prop("checked",!1)},toggleFirst:function(){var t=this.$el.find("#first"),e=!!t.prop("checked");this.toggleFee(t,e)},toggleLast:function(){var t=this.$el.find("#last"),e=!!t.prop("checked");this.toggleFee(t,e)},endChange:function(){var t,e;if(this.hasTouch?(t=moment.utc(this.start_date.val()),e=moment.utc(this.end_date.val())):(t=this.start_date.getSelectedRaw()[0],e=this.end_date.getSelectedRaw()[1]),e){e=moment(e).add("days",1);var n=moment.duration(t.diff(e)).asMonths();n=Math.abs(Math.round(n));var a;a=[12,6].contains(n)?n:"custom";var s=this.$el.find("select.type");s.val(a).trigger("chosen:updated")}},typeChange:function(){var t=this.$el.find("select.type").val(),e=!0;if(this.hasTouch?(this.start_moment=moment.utc(this.start_date.val()),this.end_moments=moment.utc(this.end_date.val())):(this.start_moment=this.start_date.getSelectedRaw()[0],this.end_moments=this.end_date.getSelectedRaw()),"edit"!=this.action){var n=this.$el.find("#start_date"),a=this.$el.find("#end_date");n.parent().removeClass("has-error").children(".help-text").text(""),a.parent().removeClass("has-error").children(".help-text").text("");var s;12==t?(s=moment.utc(this.start_moment).add("months",t).subtract("days",1),a.prop("disabled",!1),this.rentChanged()):6==t?(s=moment.utc(this.start_moment).add("months",t).subtract("days",1),a.prop("disabled",!1)):"month-to-month"==t?(a.attr("type","text"),a.val("N/A"),a.prop("disabled",!0),e=!1,this.toggleFees(!1,".last-month")):"custom"==t&&(this.hasTouch?s=moment.utc(this.end_date.val()):this.end_date.getSelectedRaw().length>1&&(s=this.end_date.getSelectedRaw()[1]),a.prop("disabled",!1)),e&&(this.hasTouch?(a.attr("type","date"),this.end_date.val(s.format("YYYY-MM-DD"))):this.end_date.setSelected([this.start_moment,s])),this.updateDueDay(),this.validateSpan()}},validateSpan:function(){var e,n;if(this.hasTouch)e=moment.utc(this.start_date.val()),n=moment.utc(this.end_date.val());else{if(this.end_date.getSelectedRaw().length<2)return!1;e=this.start_date.getSelectedRaw()[0],n=this.end_date.getSelectedRaw()[1]}this.leases&&this.leases.forEach(function(a){a.start_date<=e&&e<=a.end_date&&t.controls.fieldError({element:"#start_date",error:"Overlapping lease conflict"}),a.start_date<=n&&n<=a.end_date&&t.controls.fieldError({element:"#end_date",error:"Overlapping lease conflict"})})},constructData:function(){var e=this.$el.find("form"),n={recurring:[],scheduled:[]},a=e.serializeObject();n=_.extend(n,a.charges),a.charges=n,a.unit=this.unit.id;var s,i=this.$el.find("#first"),d=this.$el.find("#last");if(i.prop("checked")&&(s=i.siblings(".money").children("input").val(),a.charges.scheduled.push({type:"first_month",amount:"-"+t.utils.parseMoney(s)})),d.prop("checked")&&(s=d.siblings(".money").children("input").val(),a.charges.scheduled.push({type:"last_month",amount:"-"+t.utils.parseMoney(s)})),"renew"==this.action&&(a.renewed_lease_id=this.model.get("_id"),this.model.get("autopay")&&(a.autopay=this.model.get("autopay").toFixed(2))),a=t.schema.process(a,this.model),"edit"==this.action){delete a.rent,delete a.start_date,delete a.unit,delete a.lease;var r=this.model.get("charges.scheduled");r.forEach(function(t){["first_month","last_month"].indexOf(t.type)>-1&&a.charges.scheduled.push(t)})}return console.log(a),a},confirm:function(){var e=this,n=this.constructData(),a=t.utils.validate(this,n);if(!a)return!1;if(!this.model.isNew()){var s=this.model.get("tenants"),i=[];s.map(function(t){i.push(t._id)}),this.model.set("tenants",i)}t.controls.loadLock(!0),this.model.save(n).always(function(){t.controls.loadLock(!1)}).then(function(){e.context.trigger(e.eventName),e.closeModal(),t.alerts.success(e.messages.success)}).fail(function(t){e.handleError(t)})},handleError:function(e){var n,a;if(e.responseJSON&&"datespan_overlap"==e.responseJSON.error){n=e.responseJSON,a=n.message;var s=n.data.existing_lease,i=s.start_date,d=s.end_date;t.alerts.error(a+": "+i+" â€“ "+d)}},recurringCounter:0,addRecurring:function(t,e){e||(e=!1);var n=new s({options:{type:!0,description:!0},type:"recurring",name:"charges.recurring",amount:e,id:this.recurringCounter++,indexKey:"recurringCounter",context:this,min:0});this.recurring_charges.push(n),this.$el.find(".recurring").append(n.$el)},scheduledCounter:0,addScheduled:function(t,e,n){e||(e=!1),n||(n=!1);var a=new s({options:{type:!0,description:!0},type:"scheduled",name:"charges.scheduled",amount:e,date:n,context:this,id:this.scheduledCounter++,indexKey:"scheduledCounter",min:0});this.scheduled_charges.push(a),this.$el.find(".scheduled").append(a.$el)},easyClose:function(){this.changed?t.controls.modalShake(this):this.closeModal()},formChanged:function(){this.changed=!0}})});
//# sourceMappingURL=ModalLeaseView.js.map
