{"version":3,"sources":["view/modals/ModalFundingSourceView.js"],"names":["define","app","ModalView","ModalFundingSourceTemplate","extend","title","actions","confirm","cancel","template","_","initialize","_options","this","self","utils","request","path","method","then","response","iav_token","renderModalView","render","ready","renderIAV","$el","find","addClass","controls","wait","removeClass","dwolla","configure","config","dwolla_env","iav","start","container","stylesheets","url","base_url","microDeposits","fallbackToMicroDeposits","error","console","log","data","id","_links","href","split","status","closeModal","context","trigger","eventName","handleError"],"mappings":"AAIAA,QACE,MACA,wBACA,kDACA,sCAEF,SACEC,EACAC,EACAC,GAGA,MAAOD,GAAUE,QAEfC,MAAO,mBAEPC,SACEC,SAAS,EACTC,QAAQ,GAGVC,SAAUC,EAAED,SAASN,GAErBQ,WAAY,SAASC,GACfA,GAAUF,EAAEN,OAAOS,KAAMD,EAE7B,IAAIE,GAAOD,IAEXZ,GAAIc,MAAMC,SACRC,KAAM,cACNC,OAAQ,QACPC,KAAK,SAASC,GACfN,EAAKO,UAAYD,EACjBN,EAAKQ,qBAITC,OAAQ,WAMN,MAHAV,MAAKW,QACLX,KAAKY,YAEEZ,MAGTY,UAAW,WACT,GAAIX,GAAOD,IAEXA,MAAKa,IAAIC,KAAK,UAAUC,SAAS,WAEjC3B,EAAI4B,SAASC,KAAK,MAAMX,KAAK,WAC3BL,EAAKY,IAAIC,KAAK,UAAUI,YAAY,YAGtC,IAAIV,GAAYR,KAAKQ,SAErBW,QAAOC,UAAUhC,EAAIiC,OAAOC,YAC5BH,OAAOI,IAAIC,MAAMhB,GACfiB,UAAW,gBACXC,aACE,iDACAtC,EAAIuC,IAAIC,SAAW,wBAErBC,eAAe,EACfC,yBAAyB,GACxB,SAASC,EAAOxB,GAGjB,GAAIA,EAAU,CACZyB,QAAQC,IAAI1B,EAEZ,IAAI2B,IACFC,GAAI5B,EAAS6B,OAAO,kBAAkBC,KAAKC,MAAM,oBAAoB,GACrEC,OAAQhC,EAAS6B,OAAO,yBAA2B,aAAe,WAGpEhD,GAAIc,MAAMC,SACRC,KAAM,0BACNC,OAAQ,OACR6B,KAAMA,IACL5B,KAAK,WACNL,EAAKuC,aACLvC,EAAKwC,QAAQC,QAAQzC,EAAK0C,iBAInBZ,IACT3C,EAAI4B,SAAS4B,YAAYb","file":"ModalFundingSourceView.js","sourcesContent":["/**\n * ModalFundingSourceView.js\n */\n\ndefine([\n  'app',\n  'view/modals/ModalView',\n  'text!templates/modals/modal-funding-source.html',\n  'https://cdn.dwolla.com/1/dwolla.js',\n],\nfunction(\n  app, \n  ModalView,\n  ModalFundingSourceTemplate\n) {\n\n  return ModalView.extend({\n\n    title: 'Add Bank Account',\n\n    actions: {\n      confirm: false,\n      cancel: true\n    },\n\n    template: _.template(ModalFundingSourceTemplate),\n\n    initialize: function(_options) {\n      if (_options) _.extend(this, _options);\n      \n      var self = this;\n\n      app.utils.request({\n        path: 'account/iav',\n        method: 'GET'\n      }).then(function(response) {\n        self.iav_token = response;\n        self.renderModalView();\n      });\n    },\n\n    render: function() {\n      var self = this;\n\n      this.ready();\n      this.renderIAV();\n\n      return this;\n    },\n\n    renderIAV: function() {\n      var self = this;\n\n      this.$el.find('.modal').addClass('loading');\n\n      app.controls.wait(1800).then(function() {\n        self.$el.find('.modal').removeClass('loading');\n      });\n\n      var iav_token = this.iav_token;\n\n      dwolla.configure(app.config.dwolla_env);\n      dwolla.iav.start(iav_token, {\n        container: 'iav-container',\n        stylesheets: [\n          'https://fonts.googleapis.com/css?family=Roboto',\n          app.url.base_url + 'css/dwolla_style.css'\n        ],\n        microDeposits: true,\n        fallbackToMicroDeposits: true\n      }, function(error, response) {\n\n        // IAV successful\n        if (response) {\n          console.log(response)\n          \n          var data = {\n            id: response._links['funding-source'].href.split('funding-sources/')[1], // id\n            status: response._links['verify-micro-deposits'] ? 'unverified' : 'verified'\n          };\n\n          app.utils.request({\n            path: 'account/funding_sources',\n            method: 'POST',\n            data: data\n          }).then(function() {\n            self.closeModal();\n            self.context.trigger(self.eventName);\n          });\n\n        //  IAV failed\n        } else if (error) {\n          app.controls.handleError(error);\n        }\n      });\n\n    }\n  });\n});"]}