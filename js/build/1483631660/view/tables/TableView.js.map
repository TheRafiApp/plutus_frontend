{"version":3,"sources":["view/tables/TableView.js"],"names":["define","app","kalendae","FilterView","TableCollectionHeader","TableCollectionContainer","Backbone","View","extend","className","events","click .sub-header-target","click .action-edit","click .action-cancel","click .action-save","click .action-add","click .action-show-tips","click .filter-label","click .chosen-choices","mousedown .filter","mousedown .filter-label","click .action-filters","blur .action-filters","click .action-clear-filters","click .action-clear-search","click .action-sort","click .action-search","search .search-field","template_header","_","template","template_container","applyCollection","Collection","this","collection","collection_applied","preventDefault","e","stopPropagation","initialize","_options","console","error","modelPlural","modelName","options","filter","search","filters","filterViews","self","child_views","queue","context","fetch","then","collection_backup","clone","render","alerts","responseJSON","message","attachEvents","on","modelAdded","tips","renderTips","listening","collections","currentCollection","renderContainer","renderTable","$el","find","html","length","renderFilters","date","renderDate","delegateEvents","views","modelView","unitsView","id","model","get","parentModelId","addClass","role","session","utils","isMobile","remove","$search_field","chosen","change","$","trigger","searchCollection","event","target","$search_chosen","bind","value","val","keyupSearch","which","updateSearch","append","removeTags","tag","header_info","capitalize","count","model_plural","header","title","$table","tableRowView","row","each","table_row","parentView","push","row_template","totals","renderTotals","i","$field","$sort_link","field","siblings","attr","type","$column","parent","attrs_all","pluck","uniq","x","dates","filterView","updateFilters","except","attrs","removeClass","TipsView","selector","showTips","show","$totals_row","$date_filter","hasTouch","moment","format","dateChange","date_filter","Kalendae","Input","months","selected","subscribe","getSelectedRaw","invoke","today","sortCollection","hasClass","query","filterCollection","isEmpty","chosenFocus","focus","filterHack","$target","currentTarget","slaveTo","$master","closest","children","prop","changeFilter","clickedFilter","hideFilters","showFilters","clearSearch","clearFilters","utc","setSelected","hideTertiary","controls","addModel","Modal","add","addModalOptions","modal"],"mappings":"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","file":"TableView.js","sourcesContent":["/**\n * tables/TableView.js\n */\n\ndefine([\n  'app',\n  'kalendae',\n  'view/tables/FilterView',\n  'text!templates/tables/table-collection-headers.html',\n  'text!templates/tables/table-container-collection.html',\n],\nfunction(app, kalendae, FilterView, TableCollectionHeader, TableCollectionContainer) {\n\n  return Backbone.View.extend({\n    \n    className: 'table-view',\n\n    events: {\n      // close child view\n      'click .sub-header-target': 'hideTertiary',\n\n      // crud\n      'click .action-edit': 'toggleEdit',\n      'click .action-cancel': 'render',\n      'click .action-save': 'promptSave',\n      'click .action-add': 'addModel',\n\n      // tips\n      'click .action-show-tips': 'showTips',\n      \n      // event hacks\n      'click .filter-label': 'filterHack',\n      'click .chosen-choices': 'chosenFocus',\n      'mousedown .filter': 'preventDefault',\n      'mousedown .filter-label': 'preventDefault',\n\n      // toggle filters\n      'click .action-filters': 'clickedFilter',\n      'blur .action-filters': 'hideFilters',\n\n      // sorting / searching collection\n      'click .action-clear-filters': 'clearFilters',\n      'click .action-clear-search': 'clearSearch',\n      'click .action-sort': 'sortCollection',\n      'click .action-search': 'searchCollection',\n      // 'keyup .search-field': 'searchCollection',\n      'search .search-field': 'searchCollection',\n    },\n\n    template_header: _.template(TableCollectionHeader),\n    template_container: _.template(TableCollectionContainer),\n\n    applyCollection: function() {\n      var Collection = this.collection;\n      this.collection = new Collection();\n      this.collection_applied = true;\n    },\n\n    preventDefault: function(e) {\n      e.stopPropagation();\n      e.preventDefault();\n    },\n\n    initialize: function(_options) {\n      if (_options) _.extend(this, _options);\n\n      if (!this.collection) console.error('TableView missing collection');\n\n      if (!this.modelPlural) this.modelPlural = this.modelName + 's';\n\n      if (this.options.filter) {\n        if (this.options.search) {\n          console.error('TableView does not support filter and search together');\n        }\n        this.filters = {};\n        this.filterViews = {};\n      }\n\n      var self = this;\n      this.child_views = [];\n      this.queue = [];\n\n      this.template = this.context.template;\n\n      if (!this.collection_applied) this.applyCollection();\n\n      this.collection.fetch().then(function() {\n        self.collection_backup = self.collection.clone();\n        self.render();\n      }, function(error) {\n        app.alerts.error(error.responseJSON.message);\n      });\n\n    },\n\n    attachEvents: function() {\n      this.on('modelAdded', this.modelAdded, this);\n      // this.on('batchSave', this.batchSave, this);\n\n      if (this.context.tips) this.renderTips();\n      \n      this.listening = true;\n    },\n\n    render: function() {\n\n      app.collections.currentCollection = this.collection;\n\n      this.renderContainer();\n      this.renderTable();\n\n      var clone = this.$el.find('.table').clone();\n\n      // Fixed header hack\n      this.$el.find('.sub-header').html(clone);\n\n      if (!this.listening) this.attachEvents();\n\n      if (this.collection.length < 1) return this;\n\n      // Render filters\n      if (this.options.filter) this.renderFilters();\n\n      // Render date\n      if (this.options.date) this.renderDate();\n\n      // Nested view needs event delegation\n      this.delegateEvents();\n      \n      // Highlight row\n      if (app.views.modelView || app.views.unitsView) {\n\n        var id;\n\n        if (app.views.modelView) {\n          id = app.views.modelView.model.get('_id');\n        } else if (app.views.unitsView) {\n          id = app.views.unitsView.parentModelId;\n        }\n\n        this.$el.find('.row[data-id=\"' + id + '\"]').addClass('selected');\n      }\n\n      return this;\n    },\n\n    renderContainer: function() {\n      var self = this;\n\n      // Build the table container\n      this.$el.html(this.template_container({\n        options: this.options\n      }));\n\n      this.$el.find('.table-container').html(this.template({\n        role: app.session.get('user_role')\n      }));\n\n      if (!app.utils.isMobile()) {\n\n        this.$search_field = this.$el.find('.search-field').chosen()\n\n        // on uncheck\n        .change(function(e) {\n          $(this).find('option:not(:selected), option:empty').remove().trigger('chosen:updated');\n          self.searchCollection({\n            event: {\n              target: self.$el.find('.search-field')\n            }\n          });\n        });\n\n        // bind events to chosen container\n        this.$search_chosen = this.$el.find('.chosen-container')\n\n        .bind('keyup', function(e) {\n          var value = $(this).find('input').val();\n          self.keyupSearch(e, value);\n        })\n\n        .bind('keydown', function(e) {\n          // if they hit comma or line break, don't add it to the field\n          if (e.which === 13 || e.which === 188) e.preventDefault();\n        })\n\n        .find('input').bind('blur', function() {\n          var value = $(this).val();\n          self.updateSearch(value);\n        });\n\n      // if isMobile, remove search fields\n      } else {\n        this.$el.find('.search-field').remove();\n        this.$el.find('.action-search').remove();\n        this.$el.find('.action-clear-search').remove();\n      }\n    },\n\n    keyupSearch: function(e, value) {\n      if (e.which === 13 || e.which === 188) { // Enter or Comma\n        \n        // if the tag already exists\n        if (this.$search_field.find('option[value=\"' + value + '\"]').length > 0) {\n          this.$search_chosen.val('');\n          return;\n        }\n\n        this.$search_field\n        .append('<option value=\"' + value + '\" selected>' + value + '</option>')\n        .trigger('chosen:updated');\n\n        this.searchCollection();\n      }\n    },\n\n    updateSearch: function(value) {\n      if (value === '') return false;\n\n      // if the tag already exists\n      if (this.$search_field.find('option[value=\"' + value + '\"]').length > 0) {\n        this.$search_chosen.val('');\n        return;\n      }\n\n      this.$search_field\n      .append('<option value=\"' + value + '\" selected>' + value + '</option>')\n      .trigger('chosen:updated');\n    },\n\n    removeTags: function(event, tag) {\n      // remove a single tag, or all tags\n      if (tag) {\n        this.$search_field.find('option[value=\"' + tag + '\"]').remove();\n      } else {\n        this.$search_field.find('option').remove();\n      }\n      // trigger chosen update\n      this.$search_field.trigger('chosen:updated');\n    },\n\n    renderTable: function() {\n      var self = this;\n      var message = false;\n\n      if (this.collection.length < 1) message = 'No ' + this.modelPlural + ' found';\n\n      var header_info = {\n        model: app.utils.capitalize(this.modelName),\n        count: this.collection.length\n      };\n\n      if (this.modelPlural) header_info.model_plural = app.utils.capitalize(this.modelPlural);\n\n      this.$el.find('.meta').html(this.template_header({\n        header: header_info,\n        title: this.title\n      }));\n\n      var $table = this.$el.find('.tbody');\n      $table.html('');\n\n      if (message) $table.append($('<div class=\"none-found\">' + message + '</div>'));\n\n      var tableRowView = this.row;\n\n      // Append each model as a row\n      this.collection.each(function(model) {\n        var table_row = new tableRowView({ \n          model: model,\n          parentView: self \n        });\n\n        self.child_views.push(table_row);\n        self.row_template = table_row.template;\n        $table.append(table_row.$el);\n      });\n\n      if (this.collection.length < 1) return;\n      \n      if (this.options.totals) this.renderTotals();\n    },\n\n    renderFilters: function() {\n\n      var self = this;\n\n      var $fields = this.$el.find('.table-container .action-sort').each(function(i, $field) {\n        var $sort_link = $($field);\n        var $target = $sort_link.siblings('.action-filters');\n        var field = $sort_link.attr('data-field-sort') || $sort_link.attr('data-field');\n        var type = $sort_link.attr('data-filter-type');\n        var $column = $sort_link.parent();\n        \n        var attrs_all = self.collection_backup.pluck(field);\n\n        attrs_all = _.uniq(attrs_all).filter(function(x) {\n          return typeof x !== 'undefined' && x !== '';\n        });\n\n        if (type == 'date_range') {\n          self.filters[field] = {\n            dates: []\n          };\n        } else {\n          self.filters[field] = [];\n        }\n        \n        var filterView = new FilterView({\n          context: self,\n          field: field,\n          attrs_all: attrs_all,\n          type: type\n        });\n\n        self.filterViews[field] = filterView;\n\n        $column.append(filterView.$el);\n      });\n      \n    },\n\n    updateFilters: function(except) {\n      for (var filterView in this.filterViews) {\n        if (filterView == except) continue;\n\n        // Get all unique attributes\n        var attrs = this.collection.pluck(filterView);\n        attrs = _.uniq(attrs).filter(function(x) {\n          return typeof x !== 'undefined' && x !== '';\n        });\n\n        if (this.filterViews[filterView].type !== 'date_range') {\n          this.filterViews[filterView].renderFilters(attrs);\n        }\n      }\n    },\n\n    renderTips: function() {\n      var self = this;\n\n      this.$el.removeClass('no-tips');\n\n      var TipsView = app.View.TipsView;\n\n      this.tips = new TipsView({\n        selector: '.secondary',\n        context: this.context\n      });\n    },\n\n    showTips: function() {\n      this.tips.show();\n    },\n\n    renderTotals: function() {\n      var $totals_row = $('<div class=\"row totals\" />');\n\n      $totals_row.append(this.row_template(_.extend({ totals: 'TOTAL/AVG' }, this.context.totals(this))));\n\n      this.$el.find('.tbody').append($totals_row);\n    },\n\n    renderDate: function() {\n      var self = this;\n      var $date_filter = this.$el.find('.date-filter');\n\n      // Desktop - kalendae\n      if (!app.utils.hasTouch()) {\n\n        this.date_filter = new Kalendae.Input($date_filter[0], {\n          months: 1,\n          selected: moment()\n        });\n\n        this.date_filter.subscribe('change', function() {\n          self.dateChange();\n        });\n\n      // Mobile - native date picker\n      } else {\n        $date_filter.attr('type', 'date').val(moment().format('YYYY-MM-DD'));\n        $date_filter.on('change', function() {\n          self.dateChange();\n        });\n      }\n    },\n\n    dateChange: function() {\n\n      var $date_filter = this.$el.find('.date-filter');\n      var date = $date_filter.val();\n\n      // Desktop - kalendae\n      if (!app.utils.hasTouch()) {\n        // only continue if the field actually changed\n        if (this.date_filter.getSelectedRaw().length === 0) return;\n      }\n\n      if (this.date === date) return; \n\n      this.collection.invoke('set', { today: date });\n\n      this.renderTable();\n\n      this.date = date;\n    },\n\n    sortCollection: function(event) {\n      if (this.$el.find('.table').hasClass('editing')) this.render();\n\n      app.utils.sortCollection(event, this);\n    },\n\n    searchCollection: function(event) {\n      var query;\n      query = this.$search_field.val();\n\n      if (!query) {\n        this.collection = this.collection_backup;\n      } else {\n        this.collection = this.collection_backup.search(query);\n      }\n      this.sortCollection();\n    },\n\n    filterCollection: function(except) {\n      var filters = this.filters;\n\n      // console.warn(_.isEmpty(filters));\n\n      if (_.isEmpty(filters)) {\n        this.collection = this.collection_backup;\n      } else {\n        this.collection = this.collection_backup.filters(filters);\n      }\n      this.sortCollection();\n      this.updateFilters(except);\n    },\n\n    chosenFocus: function() {\n      this.$el.find('.chosen-container input').focus();\n    },\n\n    filterHack: function(event) {\n      event.preventDefault();\n      var $target = $(event.currentTarget);\n      var slaveTo = $target.attr('for');\n      var $master = $('#' + slaveTo);\n      var $field = $target.closest('.cell').children('.action-sort');\n      var field = $field.attr('data-field-sort') || $field.attr('data-field');\n\n      if ($master.prop('checked') === true) {\n        $master.prop('checked', false);\n      } else {\n        $master.prop('checked', true);\n      }\n\n      this.filterViews[field].changeFilter({\n        currentTarget: $master\n      });\n    },\n\n    clickedFilter: function(event) {\n      var $target = $(event.currentTarget);\n      var field = $target.siblings('.action-sort').attr('data-field');\n      var $column = this.$el.find('.table-container a[data-field=\"' + field + '\"]').parent();\n\n      if (!$column.hasClass('filters-active')) {\n        this.showFilters(event);\n      } else {\n        this.hideFilters(event);\n      }\n    },\n\n    showFilters: function(event) {\n      var $target = $(event.currentTarget);\n      var $sort_link = $target.siblings('.action-sort');\n      var field = $sort_link.attr('data-field');\n      var $column = this.$el.find('.table-container a[data-field=\"' + field + '\"]').parent();\n\n      $column.addClass('filters-active');\n    },\n\n    hideFilters: function(event) {\n      var $target = $(event.currentTarget);\n      var $sort_link = $target.siblings('.action-sort');\n      var field = $sort_link.attr('data-field');\n      var $column = this.$el.find('.table-container a[data-field=\"' + field + '\"]').parent();\n\n      $column.removeClass('filters-active');\n    },\n\n    clearSearch: function() {\n      this.removeTags();\n      this.searchCollection();\n    },\n\n    clearFilters: function() {\n      for (var filter in this.filters) {\n        if (this.filters[filter].dates) {\n          this.filterViews[filter].render();\n        } else {\n          this.filters[filter] = [];\n        }\n      }\n\n      this.$el.find('.has-filters').removeClass('has-filters');\n      this.filterCollection();\n\n      if (this.options.date) {\n        // Reset date filter\n        if (app.utils.isMobile()) {\n          this.$el.find('.date-filter').val(moment.utc().format('YYYY-MM-DD'));\n        } else {\n          this.date_filter.setSelected(moment.utc());\n        }\n        this.dateChange();\n      }\n    },\n\n    hideTertiary: function() {\n      if (app.views.modelView || app.views.unitsView) app.controls.hideTertiary();\n    },\n\n    addModel: function() {\n      var Modal = this.options.add;\n\n      if (Modal) {\n        var options = { context: this };\n        _.extend(options, this.options.addModalOptions);\n        this.modal = new Modal(options);\n      }\n    },\n\n    modelAdded: function() {\n      this.context.initialize();\n    }\n\n  });\n});"]}