{"version":3,"sources":["view/MybillView.js"],"names":["define","app","UserCardView","ModalTransferView","BillModel","BillTemplate","HeaderTemplate","Backbone","View","extend","className","events","click .action-pay","template","_","template_container","initialize","options","this","self","model","_id","fetch","then","render","attachEvents","on","listening","data","toJSON","path","router","getPath","split","pop","$el","html","user","session","bill","back_path","join","prettyMoney","utils","controls","maskMoney","my_id","id","tenants","get","sort","a","b","totals","each","tenant","tenant_card","amount","find","append","$","removeClass","hideTertiary","addClass","showTransferModal","mySplit","modal","action","eventName","context"],"mappings":"AAIAA,QACE,MACA,2BACA,gCACA,0BACA,mCACA,qDAEF,SAASC,EAAKC,EAAcC,EAAmBC,EAAWC,EAAcC,GAEtE,MAAOC,UAASC,KAAKC,QAEnBC,UAAW,2BAEXC,QACEC,oBAAqB,qBAIvBC,SAAUC,EAAED,SAASR,GACrBU,mBAAoBD,EAAED,SAASP,GAE/BU,WAAY,SAASC,GACnBH,EAAEL,OAAOS,KAAMD,EACf,IAAIE,GAAOD,IAEXA,MAAKE,MAAQ,GAAIhB,IAAYiB,IAAKH,KAAKG,MACvCH,KAAKE,MAAME,QAAQC,KAAK,WACtBJ,EAAKK,YAMTC,aAAc,WACZP,KAAKQ,GAAG,gBAAiBR,KAAKF,WAAYE,MAC1CA,KAAKS,WAAY,GAGnBH,OAAQ,WACN,GAAIL,GAAOD,IAENA,MAAKS,WAAWT,KAAKO,cAE1B,IAAIG,GAAOV,KAAKE,MAAMS,SAElBC,EAAO7B,EAAI8B,OAAOC,UAAUC,MAAM,IACtCH,GAAKI,MAELhB,KAAKiB,IAAIC,KAAKlB,KAAKL,UACjBwB,KAAMpC,EAAIqC,QAAQD,KAAKR,SACvBU,KAAMX,EACNY,UAAWV,EAAKW,KAAK,KACrBC,YAAazC,EAAI0C,MAAMD,eAGzBzC,EAAI2C,SAASC,UAAU,UAAW3B,KAAM,EAExC,IAAI4B,GAAQ7C,EAAIqC,QAAQD,KAAKU,EAG7B7B,MAAK8B,QAAU9B,KAAKE,MAAM6B,IAAI,WAE9B/B,KAAK8B,QAAU9B,KAAK8B,QAAQE,KAAK,SAASC,EAAGC,GAC3C,MAAID,GAAE9B,MAAQyB,GACL,EACEM,EAAE/B,MAAQyB,EACZ,EADF,QAKT,IAAIO,GAASnC,KAAKE,MAAM6B,IAAI,oBAiB5B,OAbAnC,GAAEwC,KAAKpC,KAAK8B,QAAS,SAASO,GAC5B,GAAIR,GAAKQ,EAAOlC,IAEZmC,EAAc,GAAItD,IACpB0B,KAAM2B,EACNE,OAAQJ,EAAON,IAGjB5B,GAAKgB,IAAIuB,KAAK,mBAAmBC,OAAOH,EAAYrB,OAGtDyB,EAAE,aAAaC,YAAY,WAEpB3C,MAGT4C,aAAc,WACZF,EAAE,iBAAiBC,YAAY,YAC/BD,EAAE,QAAQG,SAAS,oBAGrBC,kBAAmB,WACjB,GAAIP,EAEJ,IAA+B,YAA3BvC,KAAKE,MAAM6B,IAAI,QAAuB,CACxC,GAEIgB,GAFAhC,EAAQf,KAAKE,MAAM6B,IAAI,eACvBH,EAAQ7C,EAAIqC,QAAQD,KAAKU,EAEzBd,KAAOgC,EAAUhC,EAAMa,IAC3BW,EAASQ,MAETR,GAASvC,KAAKE,MAAM6B,IAAI,QAG1B/B,MAAKgD,MAAQ,GAAI/D,IACfgE,OAAQ,SACR/C,MAAOF,KAAKE,MACZgD,UAAW,gBACXC,QAASnD,KACTuC,OAAQA","file":"MybillView.js","sourcesContent":["/**\n * MyBillView.js\n */\n\ndefine([\n  'app',\n  'view/cards/user_payments',\n  'view/modals/ModalTransferView',\n  'model/bills/MyBillModel',\n  'text!templates/bills/mybill.html',\n  'text!templates/headers/header-tertiary-model.html',\n],\nfunction(app, UserCardView, ModalTransferView, BillModel, BillTemplate, HeaderTemplate) {\n\n  return Backbone.View.extend({\n\n    className: 'panel bill-view scroll-y',\n\n    events: {\n      'click .action-pay': 'showTransferModal',\n      // 'click .action-save': 'promptSave',\n    },\n\n    template: _.template(BillTemplate),\n    template_container: _.template(HeaderTemplate),\n\n    initialize: function(options) {\n      _.extend(this, options);\n      var self = this;\n\n      this.model = new BillModel({ _id: this._id });\n      this.model.fetch().then(function() {\n        self.render();\n      });\n\n      // Backbone.Validation.bind(this);\n    },\n\n    attachEvents: function() {\n      this.on('transferAdded', this.initialize, this);\n      this.listening = true;\n    },\n\n    render: function() {\n      var self = this;\n      \n      if (!this.listening) this.attachEvents();\n\n      var data = this.model.toJSON();\n\n      var path = app.router.getPath().split('/')\n      path.pop();\n\n      this.$el.html(this.template({ \n        user: app.session.user.toJSON(),\n        bill: data,\n        back_path: path.join('/'),\n        prettyMoney: app.utils.prettyMoney\n      }));\n\n      app.controls.maskMoney('.amount', this, 7);\n\n      var my_id = app.session.user.id;\n\n      // render tenant transfers list\n      this.tenants = this.model.get('tenants');\n\n      this.tenants = this.tenants.sort(function(a, b) {\n        if (a._id === my_id) {\n          return -1;\n        } else if (b._id === my_id) {\n          return 1;\n        }\n      });\n      \n      var totals = this.model.get('transfers_by_user');\n\n      // console.log(totals)\n\n      _.each(this.tenants, function(tenant) {\n        var id = tenant._id; \n\n        var tenant_card = new UserCardView({\n          data: tenant,\n          amount: totals[id]\n        });\n\n        self.$el.find('.transfer-cards').append(tenant_card.$el);\n      });\n\n      $('.tertiary').removeClass('loading');\n\n      return this;\n    },\n\n    hideTertiary: function() {\n      $('.row.selected').removeClass('selected');\n      $('body').addClass('tertiary-hidden');\n    },\n\n    showTransferModal: function() {\n      var amount;\n\n      if (this.model.get('type') === 'monthly') {\n        var split = this.model.get('lease.split');\n        var my_id = app.session.user.id;\n        var mySplit;\n        if (split) mySplit = split[my_id];\n        amount = mySplit;\n      } else {\n        amount = this.model.get('total');\n      }\n\n      this.modal = new ModalTransferView({\n        action: 'submit',\n        model: this.model,\n        eventName: 'transferAdded',\n        context: this,\n        amount: amount\n      });\n    }\n\n  });\n});"]}