define(["app","text!templates/account/login.html"],function(e,s){return Backbone.View.extend(_.extend({},Backbone.Events,{className:"login-container",events:{"click .action-login":"loginRequest","change #remember-me":"toggleRemember","submit form.begin":"submitForgot","submit form.end":"submitCode","submit form.reset-code":"submitReset","submit form.reset-token":"submitResetToken"},initialize:function(){return this.on("showLogin",this.showLogin,this),this.on("showForgot",this.showForgot,this),this.on("showReset",this.showReset,this),this.on("saveToken",this.saveToken,this),this.render()},render:function(){var t=e.session.get("logged_in");if(!t){this.template=_.template(s);var i=e.utils.stash.getItem("last-login")||"",o=e.utils.stash.getItem("last-pw")||"";return this.$el.html(this.template({logo:e.templates.logo(),user:i,pw:o})),$("body").removeClass("loading"),e.controls.renderPasswordFields(this),this.toggleRemember(),this.$el.find(".code").mask("ZZZâ€“ZZZ",{translation:{Z:{pattern:/[A-Za-z0-9]/}}}),this.$el}this.close()},validateContact:function(s){delete this.phone,delete this.email;var t=e.utils.validateContact(s,!0);return t.phone?(this.phone=t.phone,"phone"):t.email?(this.email=t.email,"email"):(e.alerts.error("Please enter a valid email or phone"),!1)},loginRequest:function(s){s.preventDefault(),e.utils.stash.removeItem("activation");var t,i=this.$el.find(".login .username").val(),o=this.validateContact(i),r=this.email||this.phone;if(!o)return!1;t=o;var n={password:$(".login .password").val()};n[t]=r;var a=[];for(var l in n)n[l]||($("."+l).parent().addClass("error"),a.push(e.utils.capitalize(l)));return a.length>0?(a.length>1?e.alerts.error("You have omitted required fields: "+a.join(", ")):e.alerts.error(a+" is a required field"),!1):(this.rememberForget(),void e.controls.login(n))},toggleRemember:function(s){this.$el.find("#remember-me").is(":checked")?e.utils.stash.setItem("remember-me",!0):e.utils.stash.setItem("remember-me",!1),this.rememberForget()},rememberForget:function(){if("true"==e.utils.stash.getItem("remember-me")){var s=this.$el.find(".username").val(),t=this.$el.find(".password").val();e.utils.stash.setItem("last-login",s),e.utils.stash.setItem("last-pw",t)}else e.utils.stash.removeItem("last-login"),e.utils.stash.removeItem("last-pw")},showLogin:function(){console.log("showLogin"),console.log(this.$el.find(".login")),this.$el.find(".login").addClass("visible"),this.$el.find(".forgot, .reset").removeClass("forgot-sent visible")},showForgot:function(){this.$el.find(".login, .reset").removeClass("visible");var e=this.$el.find(".forgot").removeClass("end").addClass("visible begin");e.find(".reset-code .code").removeAttr("required"),e.find(".username").prop("disabled",!1),this.$el.find(".username").focus()},showForgot2:function(){var e=this.$el.find(".forgot").addClass("end").removeClass("begin");e.find(".reset-code .code").val("").attr("required","required").focus(),e.find(".username").prop("disabled",!0),this.$el.find(".code").focus()},showReset:function(){this.$el.find(".login").removeClass("visible");var e=this.$el.find(".forgot").removeClass("visible end").addClass("begin");e.find(".reset-code .code").removeAttr("required");this.$el.find(".reset").addClass("visible");this.$el.find(".password").focus()},submitForgot:function(s){s.preventDefault();var t,i=this,o=this.$el.find(".forgot .username").val(),r=this.validateContact(o),n=this.email||this.phone;if(!r)return!1;t=r;var a={};a[t]=n,e.session.postPassword(a).then(function(){var s="Thanks, we sent you a";s+="phone"===t?" text message":"n email",s+=" with a verification code.",e.alerts.success(s),i.showForgot2()}).fail(function(s){e.controls.handleError(s)})},submitCode:function(s){s.preventDefault();var t=this,i=this.email||this.phone,o=this.email?"email":"phone",r=$.trim(this.$el.find(".forgot .code").val().toUpperCase());if(7!==r.length)return e.alerts.error("Please enter a valid code."),!1;var n={code:r};n[o]=i,e.session.putPassword(n).then(function(){e.alerts.success("Please enter a new password"),t.code=r,t.showReset()}).fail(function(){e.alerts.error("The code you have entered is invalid.")})},submitReset:function(s){s.preventDefault();var t=this.email||this.phone,i=this.email?"email":"phone",o=this.code,r=this.$el.find(".reset .password").val(),n=this.$el.find(".reset .password-confirm").val();if(r!==n)return e.alerts.error("Passwords must match"),!1;var a={password:r,code:o};a[i]=t,this.verifyLogin(a)},submitResetToken:function(s){s.preventDefault();var t=this.email||this.phone,i=this.email?"email":"phone",o=this.token,r=this.$el.find(".reset .password").val(),n=this.$el.find(".reset .password-confirm").val();if(r!==n)return e.alerts.error("Passwords must match"),!1;var a={password:r,token:o};a[i]=t,this.verifyLogin(a)},saveToken:function(){this.token=window.location.search.slice(1),this.$el.find(".reset").removeClass("reset-code").addClass("reset-token")},verifyLogin:function(s){console.log(s);var t=this;e.session.putPassword(s).then(function(i){e.alerts.success("Password succesfully reset!");var o,r;i?(o=i.email||i.phone,r=i.email?"email":"phone"):(o=t.email||t.phone,r=t.email?"email":"phone");var n={password:s.password};n[r]=o,e.controls.login(n)}).fail(function(s){e.controls.handleError(s)})}}))});
//# sourceMappingURL=Login.js.map
