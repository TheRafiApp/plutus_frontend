{"version":3,"sources":["view/account/activate/dwolla_iav.js"],"names":["define","app","OnboardingTemplate","Backbone","View","extend","className","template","_","events","click .action-next","initialize","options","this","self","user","parentView","path","session","get","utils","request","method","then","response","dwolla_data","iav_token","set","dwolla","render","fail","error","controls","handleError","$el","html","logo","templates","step","dwolla_account","primary_funding_source","renderAllSet","configure","config","dwolla_env","iav","start","container","stylesheets","url","base_url","microDeposits","fallbackToMicroDeposits","data","id","_links","href","split","status","next","find","one","$","proxy","iframeLoaded","remove","all_set_message","nextStep"],"mappings":"AAIAA,QACE,MACA,kDACA,sCAEF,SAASC,EAAKC,GAEZ,MAAOC,UAASC,KAAKC,QAEnBC,UAAW,SACXC,SAAUC,EAAED,SAASL,GAErBO,QACEC,qBAAsB,YAIxBC,WAAY,SAASC,GACfA,GAASJ,EAAEH,OAAOQ,KAAMD,EAC5B,IAAIE,GAAOD,IAEXA,MAAKE,KAAOF,KAAKG,WAAWD,IAE5B,IAAIE,EAEFA,GADEhB,EAAIiB,QAAQC,IAAI,aACX,cAEAN,KAAKE,KAAKI,IAAI,QAAU,oBAIjClB,EAAImB,MAAMC,SACRJ,KAAMA,EACNK,OAAQ,QACPC,KAAK,SAASC,GAEf,GAAIC,GAAcX,EAAKC,KAAKI,IAAI,aAChCM,GAAYC,UAAYF,EACxBV,EAAKE,WAAWD,KAAKY,KACnBC,OAAQH,IAGVX,EAAKe,WACJC,KAAK,SAASC,GACf9B,EAAI+B,SAASC,YAAYF,MAI7BF,OAAQ,WACN,GAAIf,GAAOD,IAOX,IALAA,KAAKqB,IAAIC,KAAKtB,KAAKN,UACjB6B,KAAMnC,EAAIoC,UAAUD,UAIlBvB,KAAKyB,KAAKC,gBAAkB1B,KAAKyB,KAAKC,eAAeC,uBACvD,MAAO3B,MAAK4B,cAId,IAAIf,GAAYb,KAAKE,KAAKI,IAAI,mBAkD9B,OAhDAS,QAAOc,UAAUzC,EAAI0C,OAAOC,YAC5BhB,OAAOiB,IAAIC,MAAMpB,GACfqB,UAAW,gBACXC,aACE,iDACA/C,EAAIgD,IAAIC,SAAW,wBAErBC,eAAe,EACfC,yBAAyB,GACxB,SAASrB,EAAOP,GAGjB,GAAIA,EAAU,CACZ,GAKIP,GALAoC,GACFC,GAAI9B,EAAS+B,OAAO,kBAAkBC,KAAKC,MAAM,oBAAoB,GACrEC,OAAQlC,EAAS+B,OAAO,yBAA2B,aAAe,WAMlEtC,GAFEhB,EAAIiB,QAAQC,IAAI,aAEX,0BAGAL,EAAKC,KAAKI,IAAI,QAAU,6BAGjClB,EAAImB,MAAMC,SACRJ,KAAMA,EACNK,OAAQ,OACR+B,KAAMA,IACL9B,KAAK,SAAS8B,GAEfvC,EAAKE,WAAWD,KAAKY,IAAI0B,GACzBvC,EAAKE,WAAW2C,aAIT5B,IACT9B,EAAI+B,SAASC,YAAYF,KAK7BlB,KAAKqB,IAAI0B,KAAK,UACXC,IAAI,OAAQC,EAAEC,MAAMlD,KAAKmD,aAAcnD,OAGnCA,MAGTmD,aAAc,WACZnD,KAAKqB,IAAI0B,KAAK,oBAAoBK,UAUpCxB,aAAc,WACZ,GAAIyB,GAAkB,+CACtBA,IAAmB,uEACnBA,GAAmB,+EAEnBrD,KAAKqB,IAAI0B,KAAK,kBAAkBzB,KAAK+B,IAGvCC,SAAU,WACRtD,KAAKG,WAAW2C","file":"dwolla_iav.js","sourcesContent":["/**\n * account/onboarding/dwolla_iav.js\n */\n\ndefine([\n  'app',\n  'text!templates/account/activate/dwolla_iav.html',\n  'https://cdn.dwolla.com/1/dwolla.js',\n],\nfunction(app, OnboardingTemplate) {\n\n  return Backbone.View.extend({\n\n    className: 'dwolla',\n    template: _.template(OnboardingTemplate),\n\n    events: {\n      'click .action-next': 'nextStep',\n      // 'load iframe': 'loaded'\n    },\n\n    initialize: function(options) {\n      if (options) _.extend(this, options);\n      var self = this;\n\n      this.user = this.parentView.user;\n\n      var path;\n      if (app.session.get('logged_in')) {\n        path = 'account/iav';\n      } else {\n        path = this.user.get('role') + 's/activate/dwolla';\n      }\n\n      // get IAV token\n      app.utils.request({\n        path: path,\n        method: 'GET'\n      }).then(function(response) {\n\n        var dwolla_data = self.user.get('dwolla') || {};\n        dwolla_data.iav_token = response;\n        self.parentView.user.set({\n          dwolla: dwolla_data\n        });\n\n        self.render();\n      }).fail(function(error) {\n        app.controls.handleError(error);\n      });\n    },\n\n    render: function() {\n      var self = this;\n\n      this.$el.html(this.template({\n        logo: app.templates.logo()\n      }));\n      \n      // check if the user has already done this step\n      if (this.step.dwolla_account && this.step.dwolla_account.primary_funding_source) {\n        return this.renderAllSet();\n      }\n\n      // init dwolla.js\n      var iav_token = this.user.get('dwolla.iav_token');\n\n      dwolla.configure(app.config.dwolla_env);\n      dwolla.iav.start(iav_token, {\n        container: 'iav-container',\n        stylesheets: [\n          'https://fonts.googleapis.com/css?family=Roboto',\n          app.url.base_url + 'css/dwolla_style.css'\n        ],\n        microDeposits: false,\n        fallbackToMicroDeposits: true\n      }, function(error, response) {\n\n        // IAV successful\n        if (response) {\n          var data = {\n            id: response._links['funding-source'].href.split('funding-sources/')[1], // id\n            status: response._links['verify-micro-deposits'] ? 'unverified' : 'verified'\n          };\n\n          var path;\n          if (app.session.get('logged_in')) {\n            // if already active, just \n            path = 'account/funding_sources';\n          } else {\n            // if activating, set primary\n            path = self.user.get('role') + 's/activate/funding_sources';\n          }\n\n          app.utils.request({\n            path: path,\n            method: 'POST',\n            data: data\n          }).then(function(data) {\n            // user has new primary funding source :D\n            self.parentView.user.set(data);\n            self.parentView.next();\n          });\n\n        //  IAV failed\n        } else if (error) {\n          app.controls.handleError(error);\n        }\n      });\n\n      // hide loader once iframe is loaded\n      this.$el.find('iframe')\n        .one('load', $.proxy(this.iframeLoaded, this));\n        // .on('error', $.proxy(this.iframeError, this));\n      \n      return this;\n    },\n\n    iframeLoaded: function() {\n      this.$el.find('.overlay.loading').remove();\n    },\n\n    // iframeError: function() {\n    //   var error_message = '<div class=\"form-model\"><h1>Bank Account</h1>';\n    //   error_message += '<div class=\"error\">Look\\'s like something went wrong!</div>';\n      \n    //   this.$el.find('#iav-container').html(all_set_message);\n    // },\n\n    renderAllSet: function() {\n      var all_set_message = '<div class=\"form-model\"><h1>Bank Account</h1>';\n      all_set_message += '<div class=\"all-set\">You\\'ve already linked your bank account!</div>';\n      all_set_message += '<div class=\"pad-20\"><a href=\"#\" class=\"btn action-next\">Next</a></div></div>';\n      \n      this.$el.find('#iav-container').html(all_set_message);\n    },\n\n    nextStep: function() {\n      this.parentView.next();\n    }\n\n  });\n});"]}