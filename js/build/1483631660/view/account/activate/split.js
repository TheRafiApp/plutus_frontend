define(["app","view/cards/user_payments","model/users/TenantModel","model/leases/MyLeaseModel","text!templates/account/activate/split.html"],function(t,e,n,i,a){return Backbone.View.extend({className:"split",template:_.template(a),events:{"click .action-next":"handleClick","change .split-amount":"validateSplit"},initialize:function(t){t&&_.extend(this,t),this.on("confirmSplit",this.nextStep,this),this.render()},render:function(){this.user=this.parentView.user.toJSON();var e=this.step.lease,n=e.rent/e.tenants.length;return this.model=new i(e),this.$el.html(this.template({logo:t.templates.logo(),total:t.utils.prettyMoney(e.rent),split:n})),this.renderChart(),t.controls.maskMoney(".money input",this,7),this.getFundingSources(),this},getFundingSources:function(){var e=this,n=this.parentView.user.get("dwolla.primary_funding_source"),i=t.session.get("logged_in")?"account":"tenants/activate";t.utils.request({path:i+"/funding_sources",method:"GET"}).then(function(t){e.primary=t.find(function(t){return t.id===n})}).fail(function(t){console.warn(t)})},getSplitData:function(e){var n=this.model.clone().toJSON(),i=this.user._id,a=n.split||{};n.tenants=n.tenants.map(function(t){return a[t._id]&&(t.split=a[t._id]),t});var r,s=n.tenants.filter(function(t){return"undefined"!=typeof t.split}).map(function(t){return{name:t._id,split:t.split}}),o=n.tenants.length-s.length,l=s.map(function(t){return t.split}).reduce(function(t,e){return t+e},0),u=o?(n.rent-l)/o:0;r=e?parseFloat(e):u;var p=n.split&&n.split.hasOwnProperty(this.user._id);p?e&&(s=s.map(function(t){return t.name==i&&(t.split=r),t})):s.push({name:i,split:r});var h=n.rent-l;h<0&&(h=0);var d=s.map(function(t){return t.split}).reduce(function(t,e){return t+e},0),c=n.rent-d;if(c<0)return this.$el.find(".split-amount").val(h),this.updateChart(h),!1;h&&s.push({name:"Remaining",split:c});var m={},f=[];s.forEach(function(t){f.push(t.name),m[t.name]=t.split});var g=m[i];return this.$el.find(".split-amount").val(t.utils.parseMoney(g)),{data:m,keys:f}},renderChart:function(i){var a=this,r=$.extend(!0,[],this.model.get("tenants")),s=this.user._id;this.cards={};var o=this.getSplitData(i);console.log(o),r=r.sort(function(t,e){return t.split?-1:1}).sort(function(t,e){return t._id===s?-1:e._id===s?1:void 0}),r=r.map(function(t){return t.split=o.data[t._id],t}),_.each(r,function(t){var i=new n(t);a.cards[i.id]=new e({data:i.toJSON(),amount:i.toJSON().split,negative:!0}),a.$el.find(".chart").append(a.cards[i.id].$el)});var l=o.data.Remaining?t.utils.prettyMoney(o.data.Remaining):"$0.00";this.$el.find(".remaining").html(l),this.getSplitData()},updateChart:function(e){var n=this.getSplitData(e),i=this.user._id;if(n){var a=t.utils.prettyMoney(n.data[i]),r=t.utils.prettyMoney(n.data.Remaining||0);this.$el.find(".remaining").html(r),this.cards[i].$el.find(".transfer-data li").html("-"+a)}},handleClick:function(){var t=this.$el.find(".split-amount").val(),e=this.getSplitData(t);e&&(this.updateChart(t),this.$el.find("#autopay").is(":checked")?this.promptConfirm(t):this.nextStep())},validateSplit:function(e){var n=$(e.currentTarget).val(),i=t.utils.validateMoney(n);i?(e.stopPropagation(),t.controls.fieldError({element:$(e.currentTarget),type:"error",error:i})):this.updateChart(n)},promptConfirm:function(e){var n=this.step.lease.bill_due_day,i="You have opted to autopay your rent amount of ";i+=t.utils.prettyMoney(e),i+=', from your account "',i+=this.primary.name,i+='" to ',i+=this.parentView.user.get("company.name"),i+=". Per your lease, you will be charged this amount on the ",i+=n+t.utils.getOrdinal(n),i+=" of each month.",t.controls.modalConfirm(i,"confirmSplit",this)},nextStep:function(){var e=this,n={split:this.$el.find(".split-amount").val(),autopay:this.$el.find("#autopay").is(":checked")},i=t.schema.process(n,this.model);this.model.save(i).then(function(t){e.parentView.user.set(t),e.parentView.next()}).fail(function(){console.warn(arguments)})}})});
//# sourceMappingURL=split.js.map
