define(["app","kalendae","view/tables/FilterView","text!templates/tables/table-collection-headers.html","text!templates/tables/table-container-collection.html"],function(e,t,i,l,n){return Backbone.View.extend({className:"table-view",events:{"click .sub-header-target":"hideTertiary","click .action-edit":"toggleEdit","click .action-cancel":"render","click .action-save":"promptSave","click .action-add":"addModel","click .action-show-tips":"showTips","click .filter-label":"filterHack","click .chosen-choices":"chosenFocus","mousedown .filter":"preventDefault","mousedown .filter-label":"preventDefault","click .action-filters":"clickedFilter","blur .action-filters":"hideFilters","click .action-clear-filters":"clearFilters","click .action-clear-search":"clearSearch","click .action-sort":"sortCollection","click .action-search":"searchCollection","search .search-field":"searchCollection"},template_header:_.template(l),template_container:_.template(n),applyCollection:function(){var e=this.collection;this.collection=new e,this.collection_applied=!0},preventDefault:function(e){e.stopPropagation(),e.preventDefault()},initialize:function(t){t&&_.extend(this,t),this.collection||console.error("TableView missing collection"),this.modelPlural||(this.modelPlural=this.modelName+"s"),this.options.filter&&(this.options.search&&console.error("TableView does not support filter and search together"),this.filters={},this.filterViews={});var i=this;this.child_views=[],this.queue=[],this.template=this.context.template,this.collection_applied||this.applyCollection(),this.collection.fetch().then(function(){i.collection_backup=i.collection.clone(),i.render()},function(t){e.alerts.error(t.responseJSON.message)})},attachEvents:function(){this.on("modelAdded",this.modelAdded,this),this.context.tips&&this.renderTips(),this.listening=!0},render:function(){e.collections.currentCollection=this.collection,this.renderContainer(),this.renderTable();var t=this.$el.find(".table").clone();if(this.$el.find(".sub-header").html(t),this.listening||this.attachEvents(),this.collection.length<1)return this;if(this.options.filter&&this.renderFilters(),this.options.date&&this.renderDate(),this.delegateEvents(),e.views.modelView||e.views.unitsView){var i;e.views.modelView?i=e.views.modelView.model.get("_id"):e.views.unitsView&&(i=e.views.unitsView.parentModelId),this.$el.find('.row[data-id="'+i+'"]').addClass("selected")}return this},renderContainer:function(){var t=this;this.$el.html(this.template_container({options:this.options})),this.$el.find(".table-container").html(this.template({role:e.session.get("user_role")})),e.utils.isMobile()?(this.$el.find(".search-field").remove(),this.$el.find(".action-search").remove(),this.$el.find(".action-clear-search").remove()):(this.$search_field=this.$el.find(".search-field").chosen().change(function(e){$(this).find("option:not(:selected), option:empty").remove().trigger("chosen:updated"),t.searchCollection({event:{target:t.$el.find(".search-field")}})}),this.$search_chosen=this.$el.find(".chosen-container").bind("keyup",function(e){var i=$(this).find("input").val();t.keyupSearch(e,i)}).bind("keydown",function(e){13!==e.which&&188!==e.which||e.preventDefault()}).find("input").bind("blur",function(){var e=$(this).val();t.updateSearch(e)}))},keyupSearch:function(e,t){if(13===e.which||188===e.which){if(this.$search_field.find('option[value="'+t+'"]').length>0)return void this.$search_chosen.val("");this.$search_field.append('<option value="'+t+'" selected>'+t+"</option>").trigger("chosen:updated"),this.searchCollection()}},updateSearch:function(e){return""!==e&&(this.$search_field.find('option[value="'+e+'"]').length>0?void this.$search_chosen.val(""):void this.$search_field.append('<option value="'+e+'" selected>'+e+"</option>").trigger("chosen:updated"))},removeTags:function(e,t){t?this.$search_field.find('option[value="'+t+'"]').remove():this.$search_field.find("option").remove(),this.$search_field.trigger("chosen:updated")},renderTable:function(){var t=this,i=!1;this.collection.length<1&&(i="No "+this.modelPlural+" found");var l={model:e.utils.capitalize(this.modelName),count:this.collection.length};this.modelPlural&&(l.model_plural=e.utils.capitalize(this.modelPlural)),this.$el.find(".meta").html(this.template_header({header:l,title:this.title}));var n=this.$el.find(".tbody");n.html(""),i&&n.append($('<div class="none-found">'+i+"</div>"));var s=this.row;this.collection.each(function(e){var i=new s({model:e,parentView:t});t.child_views.push(i),t.row_template=i.template,n.append(i.$el)}),this.collection.length<1||this.options.totals&&this.renderTotals()},renderFilters:function(){var e=this;this.$el.find(".table-container .action-sort").each(function(t,l){var n=$(l),s=(n.siblings(".action-filters"),n.attr("data-field-sort")||n.attr("data-field")),o=n.attr("data-filter-type"),a=n.parent(),r=e.collection_backup.pluck(s);r=_.uniq(r).filter(function(e){return"undefined"!=typeof e&&""!==e}),"date_range"==o?e.filters[s]={dates:[]}:e.filters[s]=[];var c=new i({context:e,field:s,attrs_all:r,type:o});e.filterViews[s]=c,a.append(c.$el)})},updateFilters:function(e){for(var t in this.filterViews)if(t!=e){var i=this.collection.pluck(t);i=_.uniq(i).filter(function(e){return"undefined"!=typeof e&&""!==e}),"date_range"!==this.filterViews[t].type&&this.filterViews[t].renderFilters(i)}},renderTips:function(){this.$el.removeClass("no-tips");var t=e.View.TipsView;this.tips=new t({selector:".secondary",context:this.context})},showTips:function(){this.tips.show()},renderTotals:function(){var e=$('<div class="row totals" />');e.append(this.row_template(_.extend({totals:"TOTAL/AVG"},this.context.totals(this)))),this.$el.find(".tbody").append(e)},renderDate:function(){var t=this,i=this.$el.find(".date-filter");e.utils.hasTouch()?(i.attr("type","date").val(moment().format("YYYY-MM-DD")),i.on("change",function(){t.dateChange()})):(this.date_filter=new Kalendae.Input(i[0],{months:1,selected:moment()}),this.date_filter.subscribe("change",function(){t.dateChange()}))},dateChange:function(){var t=this.$el.find(".date-filter"),i=t.val();(e.utils.hasTouch()||0!==this.date_filter.getSelectedRaw().length)&&this.date!==i&&(this.collection.invoke("set",{today:i}),this.renderTable(),this.date=i)},sortCollection:function(t){this.$el.find(".table").hasClass("editing")&&this.render(),e.utils.sortCollection(t,this)},searchCollection:function(e){var t;t=this.$search_field.val(),t?this.collection=this.collection_backup.search(t):this.collection=this.collection_backup,this.sortCollection()},filterCollection:function(e){var t=this.filters;_.isEmpty(t)?this.collection=this.collection_backup:this.collection=this.collection_backup.filters(t),this.sortCollection(),this.updateFilters(e)},chosenFocus:function(){this.$el.find(".chosen-container input").focus()},filterHack:function(e){e.preventDefault();var t=$(e.currentTarget),i=t.attr("for"),l=$("#"+i),n=t.closest(".cell").children(".action-sort"),s=n.attr("data-field-sort")||n.attr("data-field");l.prop("checked")===!0?l.prop("checked",!1):l.prop("checked",!0),this.filterViews[s].changeFilter({currentTarget:l})},clickedFilter:function(e){var t=$(e.currentTarget),i=t.siblings(".action-sort").attr("data-field"),l=this.$el.find('.table-container a[data-field="'+i+'"]').parent();l.hasClass("filters-active")?this.hideFilters(e):this.showFilters(e)},showFilters:function(e){var t=$(e.currentTarget),i=t.siblings(".action-sort"),l=i.attr("data-field"),n=this.$el.find('.table-container a[data-field="'+l+'"]').parent();n.addClass("filters-active")},hideFilters:function(e){var t=$(e.currentTarget),i=t.siblings(".action-sort"),l=i.attr("data-field"),n=this.$el.find('.table-container a[data-field="'+l+'"]').parent();n.removeClass("filters-active")},clearSearch:function(){this.removeTags(),this.searchCollection()},clearFilters:function(){for(var t in this.filters)this.filters[t].dates?this.filterViews[t].render():this.filters[t]=[];this.$el.find(".has-filters").removeClass("has-filters"),this.filterCollection(),this.options.date&&(e.utils.isMobile()?this.$el.find(".date-filter").val(moment.utc().format("YYYY-MM-DD")):this.date_filter.setSelected(moment.utc()),this.dateChange())},hideTertiary:function(){(e.views.modelView||e.views.unitsView)&&e.controls.hideTertiary()},addModel:function(){var e=this.options.add;if(e){var t={context:this};_.extend(t,this.options.addModalOptions),this.modal=new e(t)}},modelAdded:function(){this.context.initialize()}})});
//# sourceMappingURL=TableView.js.map
